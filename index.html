<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Puzzle Maker — Bulan Kebangsaan (Interlocking)</title>
<style>
  :root{--bg:#0a2540;--accent:#ffd34d;--text:#eef6ff;--muted:#b8d3f0;--line:#0b2846}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  header{display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:12px 16px;background:linear-gradient(180deg,#123e70,#0f3359);border-bottom:2px solid var(--line)}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:28px;height:28px;border-radius:6px;background:conic-gradient(#fff 0 25%,#cc0001 0 50%,#010066 0 75%,#ffcc00 0 100%);box-shadow:0 0 0 2px #07223f inset}
  .title{font-weight:800;margin:0;font-size:18px}
  .controls{display:flex;flex-wrap:wrap;gap:8px}
  .btn,.select,.file{background:#0f3359;color:var(--text);border:1px solid #1a4d82;border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
  .btn:hover{background:#134674}
  input[type=file]{border:none;padding:0}
  main{padding:12px}
  .stage{position:relative;border:2px solid var(--line);border-radius:14px;min-height:70vh;overflow:hidden;touch-action:none;
    background:
      radial-gradient(circle at 30% 30%, rgba(255,255,255,.08), transparent 40%),
      radial-gradient(circle at 70% 60%, rgba(0,0,0,.15), transparent 45%),
      linear-gradient(180deg, #2f3e52, #243445 60%, #223042)}
  .stage:fullscreen,.stage:-webkit-full-screen{width:100vw!important;height:100vh!important;border:none!important;border-radius:0!important}
  body.fs .stage{position:fixed!important;inset:0!important;width:100vw!important;height:100dvh!important;border:none!important;border-radius:0!important;z-index:9999!important}
  canvas{position:absolute;inset:0}
  .toggle{background:#0f3359;border:1px solid #1a4d82;border-radius:999px;padding:6px 10px}
  .toggle.active{background:var(--accent);color:#222;border-color:#caa94a;font-weight:700}
  #miniPrev{position:absolute;right:12px;bottom:12px;width:200px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.3);border:2px solid rgba(255,255,255,.6);background:#0b1e32;padding:6px;display:none}
  #miniPrev canvas{width:100%;height:auto;display:block}
  #miniPrev .cap{font-size:12px;color:#cfe6ff;text-align:center;margin-top:4px}
  .toast{position:fixed;left:50%;top:14px;transform:translateX(-50%);background:#123e70;color:#fff;border:1px solid #1a4d82;border-radius:10px;padding:8px 12px;display:none;z-index:9}
</style>
</head>
<body>
<header>
  <div class="brand"><div class="logo"></div><h1 class="title">Selamat Menyambut Bulan Kebangsaan ke-68</h1></div>
  <div class="controls">
    <label class="file">Gambar <input id="imgInput" type="file" accept="image/*"></label>
    <label class="file">MP3 <input id="mp3Input" type="file" accept="audio/mpeg,audio/mp3"></label>
    <select id="piecesSel" class="select">
      <option value="6">6 (2×3)</option><option value="8">8 (2×4)</option>
      <option value="12" selected>12 (3×4)</option><option value="14">14 (2×7)</option>
      <option value="16">16 (4×4)</option><option value="18">18 (3×6)</option>
      <option value="20">20 (4×5)</option>
    </select>
    <button id="startBtn" class="btn">Mula Puzzle</button>
    <button id="shuffleBtn" class="btn">Kacau</button>
    <button id="previewBtn" class="toggle">Preview</button>
    <button id="magnetBtn" class="toggle active">Magnet</button>
    <button id="audioArmBtn" class="btn">Bunyi: SEDIAKAN</button>
    <button id="fullBtn" class="btn">Skrin Penuh</button>
  </div>
</header>

<main>
  <section class="stage">
    <canvas id="board"></canvas>
    <div id="miniPrev"><canvas id="miniCanvas"></canvas><div class="cap">Rujukan</div></div>
    <div id="win" style="position:absolute;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;gap:10px;background:rgba(0,0,0,.65);color:#fff">
      <h3 style="margin:0">TAHNIAH ANDA BERJAYA!</h3><p style="margin:0">SELAMAT MENYAMBUT BULAN KEBANGSAAN KE-68.</p>
      <button id="againBtn" class="btn">Main Lagi</button>
    </div>
  </section>
</main>

<div id="toast" class="toast"></div>
<footer style="padding:10px 16px;color:#b8d3f0;font-size:12px">Tip iPad: selepas muat naik MP3, tekan <b>Bunyi: SEDIAKAN</b> sekali untuk membenarkan audio dimainkan automatik apabila puzzle siap.</footer>

<script>
/* ---------- Util ---------- */
const $=s=>document.querySelector(s);
const toast=m=>{const t=$("#toast");t.textContent=m;t.style.display='block';setTimeout(()=>t.style.display='none',1800)};

/* ---------- Canvas ---------- */
const board=$("#board"), stageEl=board.parentElement, ctx=board.getContext("2d");
let W,H,scale=1; const DPR=Math.max(1,window.devicePixelRatio||1);
function resizeCanvas(){
  const pad=12, fs=!!(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement||document.body.classList.contains('fs'));
  const vw=innerWidth, vh=(visualViewport?Math.round(visualViewport.height):innerHeight);
  const w=fs?vw:stageEl.clientWidth, h=fs?vh:Math.max(520,stageEl.clientHeight);
  W=w-pad; H=h-pad; board.style.left=pad/2+"px"; board.style.top=pad/2+"px"; board.style.width=W+"px"; board.style.height=H+"px";
  board.width=Math.floor(W*DPR); board.height=Math.floor(H*DPR); ctx.setTransform(DPR,0,0,DPR,0,0); draw();
}
addEventListener("resize",resizeCanvas);
["fullscreenchange","webkitfullscreenchange","msfullscreenchange"].forEach(ev=>document.addEventListener(ev,resizeCanvas));

/* ---------- Model ---------- */
let img=null, mp3=null, audio=new Audio(), audioCtx=null, ding=null;
let rows=3, cols=4, pieces=[], slots=[];
let dragging=null, offX=0, offY=0, showPreview=false, strongMagnet=true;
let OX=0, OY=0, CELLW=0, CELLH=0; // origin & cell size di papan

const mapping={6:[2,3],8:[2,4],12:[3,4],14:[2,7],16:[4,4],18:[3,6],20:[4,5]};
function setGrid(n){[rows,cols]=mapping[n]} $("#piecesSel").onchange=e=>setGrid(+e.target.value);

/* ---------- Uploads & Audio ---------- */
$("#imgInput").addEventListener("change",e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{ img=new Image(); img.onload=()=>{toast("Gambar dimuat naik."); draw();}; img.src=ev.target.result; };
  r.readAsDataURL(f);
});
$("#mp3Input").addEventListener("change",e=>{ mp3=e.target.files[0]?URL.createObjectURL(e.target.files[0]):null; if(mp3){audio.src=mp3; toast("MP3 dimuat naik.");}});
$("#audioArmBtn").onclick=async()=>{
  try{
    if(!audioCtx){ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }
    // bunyi unlock + set ding
    const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine'; o.frequency.value=880;
    g.gain.setValueAtTime(0.0001,audioCtx.currentTime); g.gain.linearRampToValueAtTime(0.2,audioCtx.currentTime+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.25);
    o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.26);
    ding=()=>{ const o2=audioCtx.createOscillator(), g2=audioCtx.createGain(); o2.type='triangle'; o2.frequency.value=990;
      g2.gain.setValueAtTime(0.0001,audioCtx.currentTime); g2.gain.linearRampToValueAtTime(0.25,audioCtx.currentTime+0.02);
      g2.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.30);
      o2.connect(g2).connect(audioCtx.destination); o2.start(); o2.stop(audioCtx.currentTime+0.32); };
    if(mp3){ audio.src=mp3; await audio.play(); await new Promise(r=>setTimeout(r,120)); audio.pause(); audio.currentTime=0; }
    toast("Audio sedia.");
  }catch{ toast("Sentuh sekali lagi (iPad)."); }
};

/* ---------- Toggles ---------- */
$("#previewBtn").onclick=()=>{ showPreview=!showPreview; $("#previewBtn").classList.toggle("active",showPreview); $("#miniPrev").style.display=showPreview?"block":"none"; if(showPreview) renderMini(); };
$("#magnetBtn").onclick=()=>{ strongMagnet=!strongMagnet; $("#magnetBtn").classList.toggle("active",strongMagnet); };

/* ---------- Interlocking Jigsaw Path ---------- */
/* bentuk knob bulat (male=1, female=-1, edge=0) */
function pathJigsaw(g, x,y,w,h, edges){
  const r = Math.min(w,h)*0.22;      // jejari knob
  const neck = r*0.55;               // leher knob
  const k = Math.min(w,h)*0.08;      // sudut melengkung
  g.beginPath();
  g.moveTo(x+k, y);

  // TOP
  if(edges.top===0){ g.lineTo(x+w-k,y); }
  else{
    const dir = edges.top; // 1=tanduk keluar, -1=lekuk masuk
    const cx = x+w/2, cy = y - dir*r;
    g.lineTo(x+w*0.3, y);
    g.bezierCurveTo(x+w*0.38, y, cx-neck, y, cx-neck, y - dir*neck*0.15);
    g.arc(cx, cy, r, Math.PI*(1.0+dir*0.18), Math.PI*(0.0-dir*0.18), dir>0);
    g.bezierCurveTo(cx+neck, y, x+w*0.62, y, x+w*0.7, y);
    g.lineTo(x+w-k, y);
  }
  g.quadraticCurveTo(x+w,y,x+w,y+k);

  // RIGHT
  if(edges.right===0){ g.lineTo(x+w,y+h-k); }
  else{
    const dir = edges.right;
    const cx = x+w + dir*r, cy = y+h/2;
    g.lineTo(x+w, y+h*0.3);
    g.bezierCurveTo(x+w, y+h*0.38, x+w, cy-neck, x+w - dir*neck*0.15, cy-neck);
    g.arc(cx, cy, r, Math.PI*(1.5+dir*0.18), Math.PI*(0.5-dir*0.18), dir>0);
    g.bezierCurveTo(x+w, cy+neck, x+w, y+h*0.62, x+w, y+h*0.7);
    g.lineTo(x+w, y+h-k);
  }
  g.quadraticCurveTo(x+w,y+h,x+w-k,y+h);

  // BOTTOM
  if(edges.bottom===0){ g.lineTo(x+k,y+h); }
  else{
    const dir = edges.bottom;
    const cx = x+w/2, cy = y+h + dir*r;
    g.lineTo(x+w*0.7, y+h);
    g.bezierCurveTo(x+w*0.62, y+h, cx+neck, y+h, cx+neck, y+h + dir*neck*0.15);
    g.arc(cx, cy, r, Math.PI*(0.0+dir*0.18), Math.PI*(1.0-dir*0.18), dir<0);
    g.bezierCurveTo(cx-neck, y+h, x+w*0.38, y+h, x+w*0.3, y+h);
    g.lineTo(x+k, y+h);
  }
  g.quadraticCurveTo(x,y+h,x,y+h-k);

  // LEFT
  if(edges.left===0){ g.lineTo(x,y+k); }
  else{
    const dir = edges.left;
    const cx = x - dir*r, cy = y+h/2;
    g.lineTo(x, y+h*0.7);
    g.bezierCurveTo(x, y+h*0.62, x, cy+neck, x - dir*neck*0.15, cy+neck);
    g.arc(cx, cy, r, Math.PI*(0.5+dir*0.18), Math.PI*(1.5-dir*0.18), dir<0);
    g.bezierCurveTo(x, cy-neck, x, y+h*0.38, x, y+h*0.3);
    g.lineTo(x, y+k);
  }
  g.quadraticCurveTo(x,y,x+k,y);
  g.closePath();
}

/* Bitmap kepingan (laju) */
function makeBitmapPiece(p, sW, sH){
  const c=document.createElement('canvas'), g=c.getContext('2d');
  c.width=Math.ceil(p.w + p.w*0.5);   // lebarkan sedikit utk tanduk yang keluar dari sel
  c.height=Math.ceil(p.h + p.h*0.5);
  const ox=(c.width - p.w)/2, oy=(c.height - p.h)/2;

  // KLIP bentuk jigsaw
  g.save();
  const edges=p.edges;
  pathJigsaw(g, ox, oy, p.w, p.h, edges);
  g.clip();

  // Lukis bahagian imej milik kepingan
  const sx=p.c*sW, sy=p.r*sH;
  g.imageSmoothingQuality='high';
  g.drawImage(img, sx, sy, sW, sH, ox, oy, p.w, p.h);
  g.restore();

  // Bingkai 3D ringan
  g.lineWidth=Math.max(2,Math.min(p.w,p.h)*0.06);
  g.strokeStyle="rgba(255,255,255,.95)";
  pathJigsaw(g, ox, oy, p.w, p.h, edges); g.stroke();
  g.lineWidth=1; g.strokeStyle="rgba(0,0,0,.28)";
  pathJigsaw(g, ox, oy, p.w, p.h, edges); g.stroke();

  return {bmp:c, ox, oy};
}

/* ---------- Build ---------- */
function buildPuzzle(){
  pieces=[]; slots=[];
  if(!img){toast("Muat naik gambar dahulu."); return;}

  const margin=20, boxW=W-margin*2, boxH=H-margin*2;
  const rImg=img.width/img.height, rBox=boxW/boxH;
  let tW,tH; if(rImg>rBox){tW=boxW; tH=boxW/rImg;} else {tH=boxH; tW=boxH*rImg;}
  scale=tW/img.width; OX=(W-tW)/2; OY=(H-tH)/2; CELLW=tW/cols; CELLH=tH/rows;

  /* bina tanda male/female yang padan pada grid */
  const tabsH=Array.from({length:rows},()=>Array(cols-1).fill(0));
  const tabsV=Array.from({length:rows-1},()=>Array(cols).fill(0));
  for(let r=0;r<rows;r++)for(let c=0;c<cols-1;c++) tabsH[r][c]=(Math.random()>.5?1:-1);
  for(let r=0;r<rows-1;r++)for(let c=0;c<cols;c++) tabsV[r][c]=(Math.random()>.5?1:-1);

  const sW=img.width/cols, sH=img.height/rows;

  for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
    const left  =(c===0)?0: -tabsH[r][c-1];
    const right =(c===cols-1)?0: tabsH[r][c];
    const top   =(r===0)?0: -tabsV[r-1]?.[c]||0;
    const bottom=(r===rows-1)?0: tabsV[r]?.[c]||0;

    const slot={r,c,x:OX+c*CELLW,y:OY+r*CELLH,w:CELLW,h:CELLH}; slots.push(slot);

    // Sebar di sekeliling imej
    const side=Math.floor(Math.random()*4); let px,py;
    if(side===0){ px=Math.random()*(W-CELLW)+CELLW*0.15; py=OY - CELLH*0.9*Math.random(); }
    else if(side===1){ px=W - (Math.random()*CELLW + CELLW*1.1); py=Math.random()*(H-CELLH); }
    else if(side===2){ px=Math.random()*(W-CELLW)+CELLW*0.15; py=OY + tH + CELLH*0.2 + Math.random()*CELLH; }
    else { px=OX - CELLW*0.9*Math.random(); py=Math.random()*(H-CELLH); }

    const p={r,c,x:px,y:py,w:CELLW,h:CELLH,placed:false,edges:{top,bottom,left,right}};
    Object.assign(p, makeBitmapPiece(p, sW, sH)); // bmp + offset simpan dalam p
    pieces.push(p);
  }

  if(showPreview) renderMini();
  draw();
}

/* ---------- Render ---------- */
function draw(){
  ctx.clearRect(0,0,W,H);
  // grid nipis (bantu padanan)
  ctx.save(); ctx.setLineDash([4,6]); ctx.strokeStyle="rgba(255,255,255,.10)";
  for(const s of slots) ctx.strokeRect(s.x, s.y, s.w, s.h); ctx.restore();

  for(const p of pieces){ if(p!==dragging) ctx.drawImage(p.bmp, p.x - p.ox, p.y - p.oy); }
  if(dragging) ctx.drawImage(dragging.bmp, dragging.x - dragging.ox, dragging.y - dragging.oy);
}
function renderMini(){
  const box=$("#miniPrev"), c=$("#miniCanvas"), g=c.getContext('2d'); if(!img){box.style.display="none";return;}
  const maxW=200, r=img.width/img.height; c.width=maxW; c.height=Math.round(maxW/r); g.clearRect(0,0,c.width,c.height); g.drawImage(img,0,0,c.width,c.height); box.style.display="block";
}

/* ---------- Drag + Snap (slot, grid, jiran) ---------- */
let rafId=null;
function pieceAt(px,py){
  for(let i=pieces.length-1;i>=0;i--){
    const p=pieces[i];
    const bx=p.x - p.ox, by=p.y - p.oy, bw=p.bmp.width, bh=p.bmp.height;
    if(px>=bx && px<=bx+bw && py>=by && py<=by+bh) return p;
  }
  return null;
}
function pointerDown(e){
  e.preventDefault(); board.setPointerCapture?.(e.pointerId);
  const r=board.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top;
  const p=pieceAt(x,y); if(!p) return;
  dragging=p; offX=x-p.x; offY=y-p.y;
  const i=pieces.indexOf(p); pieces.push(...pieces.splice(i,1));
  if(!rafId){ rafId=requestAnimationFrame(()=>{rafId=null; draw();}); }
}
function pointerMove(e){
  if(!dragging) return; e.preventDefault();
  const r=board.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top;
  dragging.x=x-offX; dragging.y=y-offY;
  if(!rafId){ rafId=requestAnimationFrame(()=>{rafId=null; draw();}); }
}
function snapToNearest(p){
  const tol = Math.min(p.w,p.h)*(strongMagnet?0.55:0.35);

  // 1) Snap ke slot sebenar
  const s = slots[p.r*cols + p.c];
  if(Math.hypot(p.x-s.x, p.y-s.y) < tol){ p.x=s.x; p.y=s.y; p.placed=true; return; }

  // 2) Snap ke grid terdekat
  let gc = Math.round((p.x - OX)/CELLW), gr = Math.round((p.y - OY)/CELLH);
  gc = Math.max(0,Math.min(cols-1,gc)); gr = Math.max(0,Math.min(rows-1,gr));
  const gs = slots[gr*cols + gc];
  if(Math.hypot(p.x-gs.x,p.y-gs.y) < tol){ p.x=gs.x; p.y=gs.y; p.placed = (gr===p.r && gc===p.c); if(p.placed) return; }

  // 3) Snap ke jiran yang sudah ditempat (ikut bentuk interlock)
  const neigh = [
    {dr:0,dc:-1, tx:(q)=>q.x - CELLW, ty:(q)=>q.y},
    {dr:0,dc:+1, tx:(q)=>q.x + CELLW, ty:(q)=>q.y},
    {dr:-1,dc:0, tx:(q)=>q.x,        ty:(q)=>q.y - CELLH},
    {dr:+1,dc:0, tx:(q)=>q.x,        ty:(q)=>q.y + CELLH},
  ];
  for(const n of neigh){
    const rr=p.r+n.dr, cc=p.c+n.dc; if(rr<0||cc<0||rr>=rows||cc>=cols) continue;
    const q = pieces.find(pi=>pi.r===rr&&pi.c===cc&&pi.placed);
    if(!q) continue;
    const tx=n.tx(q), ty=n.ty(q);
    if(Math.hypot(p.x-tx,p.y-ty) < tol){ p.x=tx; p.y=ty; p.placed=(p.x===s.x && p.y===s.y); return; }
  }
}
function pointerUp(e){ if(!dragging) return; e.preventDefault(); snapToNearest(dragging); dragging=null; draw(); checkWin(); }

board.addEventListener("pointerdown",pointerDown,{passive:false});
board.addEventListener("pointermove",pointerMove,{passive:false});
board.addEventListener("pointerup",pointerUp,{passive:false});
board.addEventListener("pointercancel",pointerUp,{passive:false});

/* ---------- Menang & Kawalan ---------- */
function checkWin(){
  if(pieces.length && pieces.every(p=>p.placed)){
    $("#win").style.display="flex";
    if(mp3){ audio.currentTime=0; audio.play().catch(()=>{}); }
    else if(ding){ ding(); }
  }
}
$("#againBtn").onclick=()=>{ $("#win").style.display="none"; shuffle(); };
function shuffle(){ for(const p of pieces){ p.placed=false; p.x=Math.random()*(W-p.w)+p.w*0.1; p.y=Math.random()*(H-p.h)+p.h*0.1;} draw(); }
$("#shuffleBtn").onclick=shuffle;
$("#startBtn").onclick=()=>{ if(!img){toast("Muat naik gambar dahulu."); return;} setGrid(+$("#piecesSel").value); buildPuzzle(); toast(`Puzzle ${rows*cols} keping (interlocking) siap.`); };

/* ---------- Fullscreen ---------- */
function fsSupported(){return !!(document.fullscreenEnabled||document.webkitFullscreenEnabled)}
function isFS(){return !!(document.fullscreenElement||document.webkitFullscreenElement)}
function enterFS(el){(el.requestFullscreen||el.webkitRequestFullscreen)?.call(el)}
function exitFS(){(document.exitFullscreen||document.webkitExitFullscreen)?.call(document)}
function usePseudoFS(on){document.body.classList.toggle('fs',!!on);resizeCanvas()}
$("#fullBtn").onclick=()=>{ if(fsSupported()){ if(!isFS()) enterFS(stageEl); else exitFS(); } else { usePseudoFS(!document.body.classList.contains('fs')); } };
["fullscreenchange","webkitfullscreenchange"].forEach(ev=>document.addEventListener(ev,()=>{ if(!isFS()) document.body.classList.remove('fs'); resizeCanvas(); }));

/* ---------- Init ---------- */
resizeCanvas();
</script>
</body>
</html>
