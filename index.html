<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Puzzle Kebangsaan — Stabil + Muzik</title>
<style>
:root{--bg:#0a2540;--panel:#0f3359;--line:#0b2846;--text:#eaf3ff;--accent:#ffd34d}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 16px;background:linear-gradient(180deg,#123e70,#0f3359);border-bottom:2px solid var(--line)}
.controls{display:flex;flex-wrap:wrap;gap:8px}
.btn,.select,.file,.rangeWrap{background:var(--panel);color:var(--text);border:1px solid #1a4d82;border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
.btn:hover{background:#134674}
.file input[type=file]{border:none;padding:0}
.rangeWrap{display:flex;align-items:center;gap:8px}
.rangeWrap input{accent-color:#ffd34d}
main{padding:12px}
.stage{
  position:relative;border:2px solid var(--line);border-radius:14px;min-height:70vh;overflow:hidden;touch-action:none;
  background:
    radial-gradient(ellipse at center, rgba(0,0,0,.35), rgba(0,0,0,0) 60%) center/140% 140% no-repeat,
    url('data:image/svg+xml;utf8,\
    <svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120">\
      <filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2"/></filter>\
      <rect width="120" height="120" fill="#2b3542"/>\
      <rect width="120" height="120" filter="url(%23n)" opacity=".12"/>\
    </svg>') repeat;
}
canvas{position:absolute;inset:0}
.toggle{background:var(--panel);border:1px solid #1a4d82;border-radius:999px;padding:6px 10px}
.toggle.active{background:var(--accent);color:#222;border-color:#c9a43c;font-weight:700}
#win{position:absolute;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;gap:10px;background:rgba(0,0,0,.65);color:#fff}
.toast{position:fixed;left:50%;top:14px;transform:translateX(-50%);background:#123e70;color:#fff;border:1px solid #1a4d82;border-radius:10px;padding:8px 12px;display:none;z-index:9}
footer{padding:10px 16px;color:#b8d3f0;font-size:12px}
</style>
</head>
<body>
<header>
  <div style="font-weight:800">Selamat Menyambut Bulan Kebangsaan ke-68</div>
  <div class="controls">
    <label class="file">Gambar <input id="imgInput" type="file" accept="image/*"></label>

    <select id="piecesSel" class="select">
      <option value="6">6 (2×3)</option>
      <option value="8">8 (2×4)</option>
      <option value="10">10 (2×5)</option>
      <option value="12" selected>12 (3×4)</option>
      <option value="14">14 (2×7)</option>
      <option value="16">16 (4×4)</option>
      <option value="18">18 (3×6)</option>
      <option value="20">20 (4×5)</option>
      <option value="22">22 (2×11)</option>
      <option value="24">24 (3×8)</option>
    </select>

    <button id="patternBtn" class="btn">Corak: Klasik</button>
    <button id="startBtn"   class="btn">Mula Puzzle</button>
    <button id="shuffleBtn" class="btn">Kacau</button>
    <button id="previewBtn" class="toggle">Preview</button>
    <button id="fsBtn" class="btn">Skrin Penuh</button>

    <!-- Muzik MP3 -->
    <label class="file">Muzik MP3 <input id="mp3Input" type="file" accept="audio/mpeg,audio/mp3,audio/*"></label>
    <button id="musicPlay" class="btn" title="Mainkan muzik">Mainkan Muzik</button>
    <button id="musicPause" class="btn" title="Hentikan muzik">Henti Muzik</button>
    <div class="rangeWrap" title="Volum">
      Volum
      <input id="volRange" type="range" min="0" max="1" step="0.05" value="0.7">
    </div>
    <button id="autoMusicBtn" class="toggle" title="Main muzik bila siap">Auto Muzik: Mati</button>
  </div>
</header>

<main>
  <section id="stage" class="stage">
    <canvas id="board"></canvas>
    <div id="win">
      <h3 style="margin:0">TAHNIAH ANDA BERJAYA!</h3>
      <p style="margin:0">SELAMAT MENYAMBUT BULAN KEBANGSAAN KE-68.</p>
      <button id="againBtn" class="btn">Main Lagi</button>
    </div>
  </section>
</main>

<div id="toast" class="toast"></div>
<footer>Tip: Muat naik gambar → Mula Puzzle. Guna “Preview” untuk rujukan pucuk/celah. Muat naik MP3 untuk muzik latar.</footer>

<!-- Elemen audio tersembunyi -->
<audio id="bgm" preload="auto"></audio>

<script>
/* ===== util ===== */
function $(s){return document.querySelector(s);}
function toast(m){var t=$("#toast");t.textContent=m;t.style.display='block';setTimeout(function(){t.style.display='none';},1600);}

/* ===== canvas ===== */
var stageEl=$("#stage");
var board=$("#board"), ctx=board.getContext("2d");
var W=0,H=0,DPR=Math.max(1,window.devicePixelRatio||1);
function resizeCanvas(){
  var pad=12, w=stageEl.clientWidth, h=Math.max(520,stageEl.clientHeight);
  W=w-pad; H=h-pad;
  board.style.left=(pad/2)+"px"; board.style.top=(pad/2)+"px";
  board.style.width=W+"px"; board.style.height=H+"px";
  board.width=Math.floor(W*DPR); board.height=Math.floor(H*DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
  draw();
}
window.addEventListener("resize",function(){
  resizeCanvas();
  if(img && piecesBuilt) buildPuzzle();
});

/* ===== state ===== */
var img=null;
var rows=3, cols=4, pieces=[], slots=[];
var OX=0, OY=0, CELLW=0, CELLH=0, dragging=null, offX=0, offY=0;
var showPreview=false, viewW=0, viewH=0;
var piecesBuilt=false, classicPattern=true;

/* ===== audio state ===== */
var bgm=$("#bgm");
var autoMusic=false;
$("#volRange").addEventListener("input", e => { bgm.volume = +e.target.value; });
bgm.volume = +$("#volRange").value;

$("#mp3Input").addEventListener("change", function(e){
  var f=e.target.files[0]; if(!f) return;
  var url=URL.createObjectURL(f);
  bgm.src=url;
  toast("Muzik dimuat naik.");
});
$("#musicPlay").onclick=function(){
  if(!bgm.src){ toast("Muat naik fail MP3 dahulu."); return; }
  bgm.loop=true;
  bgm.play().catch(()=>toast("Tekan butang ini sekali lagi untuk benarkan mainan."));
};
$("#musicPause").onclick=function(){ bgm.pause(); };
$("#autoMusicBtn").onclick=function(){
  autoMusic=!autoMusic;
  this.textContent = "Auto Muzik: " + (autoMusic?"Hidup":"Mati");
  this.classList.toggle("active",autoMusic);
};

/* ===== uploads ===== */
$("#imgInput").addEventListener("change",function(e){
  var f=e.target.files[0]; if(!f) return;
  var r=new FileReader();
  r.onload=function(ev){
    img=new Image();
    img.onload=function(){ toast("Gambar dimuat naik."); buildPuzzle(); };
    img.src=ev.target.result;
  };
  r.readAsDataURL(f);
});

/* ===== fullscreen ===== */
function isFS(){return document.fullscreenElement||document.webkitFullscreenElement;}
$("#fsBtn").onclick=function(){
  try{
    if(!isFS()){
      var el=stageEl;
      if(el.requestFullscreen) el.requestFullscreen();
      else if(el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      $("#fsBtn").textContent="Keluar Skrin Penuh";
    }else{
      if(document.exitFullscreen) document.exitFullscreen();
      else if(document.webkitExitFullscreen) document.webkitExitFullscreen();
      $("#fsBtn").textContent="Skrin Penuh";
    }
  }catch(e){}
};
document.addEventListener("fullscreenchange",function(){ $("#fsBtn").textContent=isFS()?"Keluar Skrin Penuh":"Skrin Penuh"; });

/* ===== controls ===== */
var mapping={6:[2,3],8:[2,4],10:[2,5],12:[3,4],14:[2,7],16:[4,4],18:[3,6],20:[4,5],22:[2,11],24:[3,8]};
$("#piecesSel").onchange=function(e){ var v=+e.target.value; rows=mapping[v][0]; cols=mapping[v][1]; if(img) buildPuzzle(); };
$("#patternBtn").onclick=function(){ classicPattern=!classicPattern; $("#patternBtn").textContent="Corak: "+(classicPattern?"Klasik":"Rawak"); if(img) buildPuzzle(); };
$("#previewBtn").onclick=function(){ showPreview=!showPreview; $("#previewBtn").classList.toggle("active",showPreview); draw(); };
$("#startBtn").onclick=function(){ if(!img){toast("Muat naik gambar dahulu.");return;} buildPuzzle(); bgm.play().catch(()=>{}); };
$("#shuffleBtn").onclick=function(){ shuffle(); };

/* ===== bentuk jigsaw ===== */
var TAB_R=0.20, BOW=0.035, INSET=0.10, KAPPA=0.5522847498307936;
function pathJigsaw(c, x, y, w, h, edges){
  var r=Math.min(w,h), R=r*TAB_R, bow=r*BOW, nk=R*INSET, k=KAPPA;
  c.beginPath(); c.moveTo(x,y);
  // TOP
  if(edges.top===0){ c.bezierCurveTo(x+w*.25,y-bow, x+w*.75,y-bow, x+w,y); }
  else{ var d=edges.top, cy=y - d*(R+bow*.15), L=x+w/2-R, Rr=x+w/2+R;
    c.bezierCurveTo(x+w*.25,y-bow, L-nk,y-bow, L,y);
    c.bezierCurveTo(L, y+d*R*k, x+w/2-R*k, cy, x+w/2, cy);
    c.bezierCurveTo(x+w/2+R*k, cy, Rr, y+d*R*k, Rr, y);
    c.bezierCurveTo(Rr+nk, y-bow, x+w*.75,y-bow, x+w,y); }
  // RIGHT
  if(edges.right===0){ c.bezierCurveTo(x+w+bow,y+h*.25, x+w+bow,y+h*.75, x+w,y+h); }
  else{ d=edges.right; var cx=x+w + d*(R+bow*.15), T=y+h/2-R, B=y+h/2+R;
    c.bezierCurveTo(x+w+bow, y+h*.25, x+w+bow, T-nk, x+w, T);
    c.bezierCurveTo(x+w+d*R*k, T, cx, y+h/2-R*k, cx, y+h/2);
    c.bezierCurveTo(cx, y+h/2+R*k, x+w+d*R*k, B, x+w, B);
    c.bezierCurveTo(x+w+bow, B+nk, x+w+bow, y+h*.75, x+w, y+h); }
  // BOTTOM
  if(edges.bottom===0){ c.bezierCurveTo(x+w*.75,y+h+bow, x+w*.25,y+h+bow, x, y+h); }
  else{ d=edges.bottom; cy=y+h + d*(R+bow*.15); var Rr2=x+w/2+R, L2=x+w/2-R;
    c.bezierCurveTo(x+w*.75, y+h+bow, Rr2+nk, y+h+bow, Rr2, y+h);
    c.bezierCurveTo(Rr2, y+h-d*R*k, x+w/2+R*k, cy, x+w/2, cy);
    c.bezierCurveTo(x+w/2-R*k, cy, L2, y+h-d*R*k, L2, y+h);
    c.bezierCurveTo(L2-nk, y+h+bow, x+w*.25, y+h+bow, x, y+h); }
  // LEFT
  if(edges.left===0){ c.bezierCurveTo(x-bow,y+h*.75, x-bow,y+h*.25, x, y); }
  else{ d=edges.left; cx=x - d*(R+bow*.15); B=y+h/2+R; T=y+h/2-R;
    c.bezierCurveTo(x-bow, y+h*.75, x-bow, B+nk, x, B);
    c.bezierCurveTo(x-d*R*k, B, cx, y+h/2+R*k, cx, y+h/2);
    c.bezierCurveTo(cx, y+h/2-R*k, x-d*R*k, T, x, T);
    c.bezierCurveTo(x-bow, T-nk, x-bow, y+h*.25, x, y); }
  c.closePath();
}

/* ===== bina puzzle (kepingan lebih kecil) ===== */
function buildPuzzle(){
  pieces=[]; slots=[]; piecesBuilt=true;

  var margin=22, boxW=W-margin*2, boxH=H-margin*2;
  // fit gambar
  var rImg=img.width/img.height, rBox=boxW/boxH, tW,tH;
  if(rImg>rBox){ tW=boxW; tH=boxW/rImg; } else { tH=boxH; tW=boxH*rImg; }

  // ——— SAIZ KEPINGAN DIKECILKAN ———
  // Nilai asal: MIN 80, MAX_TARGET 180 → kini lebih kecil & halus
  var MIN_PIECE_PX=Math.max(48, Math.min(boxW,boxH)/Math.max(cols,rows)*0.60);
  var MAX_TARGET=Math.min(120, Math.max(boxW,boxH)/6);
  var NATIVE_MAX=Math.min(img.width/cols, img.height/rows);
  var MAX_PIECE_PX=Math.max(MIN_PIECE_PX, Math.min(MAX_TARGET, NATIVE_MAX));
  var curPiece=Math.min(tW/cols, tH/rows);
  if(curPiece>MAX_PIECE_PX){ var s=MAX_PIECE_PX/curPiece; tW*=s; tH*=s; }
  else if(curPiece<MIN_PIECE_PX){ s=MIN_PIECE_PX/curPiece; tW*=s; tH*=s; var over=Math.max(tW/boxW,tH/boxH); if(over>1){ tW/=over; tH/=over; } }

  viewW=tW; viewH=tH; OX=(W-tW)/2; OY=(H-tH)/2; CELLW=tW/cols; CELLH=tH/rows;

  // corak tabs
  var tabsH=[], tabsV=[];
  for(var r=0;r<rows;r++){ tabsH[r]=[]; for(var c=0;c<cols-1;c++){ tabsH[r][c]= classicPattern ? ((r+c)%2===0?1:-1) : (Math.random()>.5?1:-1); } }
  for(r=0;r<rows-1;r++){ tabsV[r]=[]; for(c=0;c<cols;c++){ tabsV[r][c]= classicPattern ? ((r+c)%2===0?1:-1) : (Math.random()>.5?1:-1); } }

  var sW=img.width/cols, sH=img.height/rows;

  for(r=0;r<rows;r++)for(c=0;c<cols;c++){
    var left=(c===0)?0:-tabsH[r][c-1];
    var right=(c===cols-1)?0:tabsH[r][c];
    var top=(r===0)?0: - (tabsV[r-1] ? tabsV[r-1][c] : 0);
    var bottom=(r===rows-1)?0: (tabsV[r] ? tabsV[r][c] : 0);

    var slot={r:r,c:c,x:OX+c*CELLW,y:OY+r*CELLH,w:CELLW,h:CELLH}; slots.push(slot);

    // render dua gaya (HiDPI 2x)
    var PAD=0.22, SCALE=2;
    var cw=Math.ceil(CELLW*(1+PAD*2)*SCALE), ch=Math.ceil(CELLH*(1+PAD*2)*SCALE);

    function renderPieceCanvas(withShadow){
      var can=document.createElement('canvas'); can.width=cw; can.height=ch;
      var g=can.getContext('2d'); g.imageSmoothingEnabled=true; g.imageSmoothingQuality='high';
      g.scale(SCALE,SCALE);
      var ox=CELLW*PAD, oy=CELLH*PAD;

      pathJigsaw(g, ox, oy, CELLW, CELLH, {top:top,bottom:bottom,left:left,right:right});

      g.save(); g.clip();
      var sx=c*sW, sy=r*sH; g.drawImage(img, sx, sy, sW, sH, ox, oy, CELLW, CELLH);
      g.restore();

      g.save(); g.clip();
      var ish=g.createLinearGradient(ox,oy, ox+CELLW, oy+CELLH);
      ish.addColorStop(0,'rgba(0,0,0,.10)'); ish.addColorStop(0.5,'rgba(0,0,0,0)');
      g.globalCompositeOperation='multiply'; g.fillStyle=ish; g.fillRect(ox-4,oy-4,CELLW+8,CELLH+8);
      g.restore();

      if(withShadow){
        g.save();
        g.shadowColor='rgba(0,0,0,.30)'; g.shadowBlur=8; g.shadowOffsetY=3;
        g.lineJoin='round'; g.lineCap='round';
        g.lineWidth=Math.max(1.6,Math.min(CELLW,CELLH)*0.045);
        g.strokeStyle='rgba(255,255,255,.98)';
        pathJigsaw(g, ox, oy, CELLW, CELLH, {top:top,bottom:bottom,left:left,right:right}); g.stroke();
        g.restore();

        g.save(); g.lineJoin='round'; g.lineCap='round'; g.lineWidth=0.8; g.strokeStyle='rgba(0,0,0,.22)';
        pathJigsaw(g, ox, oy, CELLW, CELLH, {top:top,bottom:bottom,left:left,right:right}); g.stroke(); g.restore();
      }else{
        g.save();
        g.lineJoin='round'; g.lineCap='round';
        g.lineWidth=Math.max(0.8,Math.min(CELLW,CELLH)*0.018);
        g.strokeStyle='rgba(0,0,0,.20)';
        pathJigsaw(g, ox, oy, CELLW, CELLH, {top:top,bottom:bottom,left:left,right:right}); g.stroke();
        g.restore();
      }

      g.save(); g.clip();
      var gloss=g.createLinearGradient(ox,oy, ox, oy+CELLH);
      gloss.addColorStop(0,'rgba(255,255,255,.18)');
      gloss.addColorStop(0.35,'rgba(255,255,255,.06)');
      gloss.addColorStop(0.55,'rgba(255,255,255,0)');
      g.globalCompositeOperation='screen'; g.fillStyle=gloss; g.fillRect(ox,oy,CELLW,CELLH);
      g.restore();

      return {canvas:can, ox:ox, oy:oy};
    }

    var floatBmp=renderPieceCanvas(true);
    var placedBmp=renderPieceCanvas(false);

    var target={x:slot.x, y:slot.y};
    pieces.push({r:r,c:c,x:slot.x,y:slot.y,w:CELLW,h:CELLH,ox:floatBmp.ox,oy:floatBmp.oy,
                 bmpFloat:floatBmp.canvas, bmpPlaced:placedBmp.canvas, placed:false, target:target});
  }
  shuffle();
}

/* ===== rawak ===== */
function shuffle(){
  if(!piecesBuilt) return;
  var idx=[]; for(var i=0;i<slots.length;i++) idx.push(i);
  for(i=idx.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var t=idx[i]; idx[i]=idx[j]; idx[j]=t; }
  for(i=0;i<pieces.length;i++){ var s=slots[idx[i]]; pieces[i].x=s.x; pieces[i].y=s.y; pieces[i].placed=false; }
  draw();
}

/* ===== lukis ===== */
function draw(){
  ctx.clearRect(0,0,W,H);
  if(showPreview && img && viewW>0 && viewH>0){
    ctx.save(); ctx.globalAlpha=0.28;
    ctx.drawImage(img,0,0,img.width,img.height, OX,OY, viewW,viewH); ctx.restore();
  }
  for(var i=0;i<pieces.length;i++){
    var p=pieces[i]; if(p===dragging) continue;
    var bmp=p.placed ? p.bmpPlaced : p.bmpFloat;
    ctx.drawImage(bmp, p.x-p.ox, p.y-p.oy);
  }
  if(dragging){
    var bmp = dragging.placed ? dragging.bmpPlaced : dragging.bmpFloat;
    ctx.drawImage(bmp, dragging.x-dragging.ox, dragging.y-dragging.oy);
  }
}

/* ===== drag & snap ===== */
function pieceAt(px,py){
  for(var i=pieces.length-1;i>=0;i--){
    var p=pieces[i], bx=p.x-p.ox, by=p.y-p.oy, bw=p.bmpFloat.width, bh=p.bmpFloat.height;
    if(px>=bx && px<=bx+bw && py>=by && py<=by+bh) return p;
  } return null;
}
board.addEventListener("pointerdown",function(e){
  e.preventDefault();
  try{ board.setPointerCapture(e.pointerId); }catch(_){}
  var r=board.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
  var p=pieceAt(x,y); if(!p) return; dragging=p; offX=x-p.x; offY=y-p.y;
  var i=pieces.indexOf(p); pieces.push(pieces.splice(i,1)[0]); requestAnimationFrame(draw);
}, {passive:false});
board.addEventListener("pointermove",function(e){
  if(!dragging) return; e.preventDefault();
  var r=board.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
  dragging.x=x-offX; dragging.y=y-offY; requestAnimationFrame(draw);
}, {passive:false});

function snapToGrid(p){
  var col = Math.round((p.x - OX) / CELLW);
  var row = Math.round((p.y - OY) / CELLH);
  if(col<0) col=0; if(col>cols-1) col=cols-1;
  if(row<0) row=0; if(row>rows-1) row=rows-1;
  p.x = Math.round(OX + col * CELLW);
  p.y = Math.round(OY + row * CELLH);
  p.placed = (col===p.c && row===p.r);
}

board.addEventListener("pointerup",function(e){
  if(!dragging) return; e.preventDefault();
  var p=dragging; dragging=null; snapToGrid(p); draw(); checkWin();
}, {passive:false});

/* ===== menang ===== */
function checkWin(){
  if(!pieces.length) return;
  for(var i=0;i<pieces.length;i++){
    var p=pieces[i];
    if(Math.abs(p.x-p.target.x)>=0.5 || Math.abs(p.y-p.target.y)>=0.5) return;
  }
  $("#win").style.display="flex";
  if(autoMusic && bgm.src){ bgm.currentTime=0; bgm.play().catch(()=>{}); }
}
$("#againBtn").onclick=function(){ $("#win").style.display="none"; shuffle(); };

/* ===== init ===== */
resizeCanvas();
</script>
</body>
</html>
