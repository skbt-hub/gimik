<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Puzzle Malaysia — Auto Snap & Auto Music (FIX)</title>
<style>
:root{--bg:#0a2540;--panel:#0f3359;--line:#0b2846;--text:#eaf3ff;--accent:#ffd34d}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
header{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 14px;background:linear-gradient(180deg,#123e70,#0f3359);border-bottom:2px solid var(--line)}
.controls{display:flex;flex-wrap:wrap;gap:8px}
.btn,.select,.file,.range{background:var(--panel);color:var(--text);border:1px solid #1a4d82;border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
.btn[disabled]{opacity:.55;cursor:not-allowed}
.btn:hover:not([disabled]){background:#134674}
.file input[type=file]{border:none;padding:0}
.range{display:flex;align-items:center;gap:8px}
.range input{accent-color:#ffd34d}
main{padding:10px}
.stage{position:relative;border:2px solid var(--line);border-radius:14px;min-height:82vh;overflow:hidden;touch-action:none;background:#0a2540}
canvas{position:absolute;inset:0}
.toggle{background:var(--panel);border:1px solid #1a4d82;border-radius:999px;padding:6px 10px}
.toggle.active{background:var(--accent);color:#222;border-color:#c9a43c;font-weight:700}
.toast{position:fixed;left:50%;top:12px;transform:translateX(-50%);background:#123e70;color:#fff;border:1px solid #1a4d82;border-radius:10px;padding:8px 12px;display:none;z-index:9}
footer{padding:10px 14px;color:#b8d3f0;font-size:12px}

/* Paparan kemenangan */
#celebrate{position:absolute;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;background:rgba(0,0,0,.85);z-index:20}
#celebrate.show{display:flex;animation:fadeIn .45s ease both}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.big-wrap{width:min(96%,1200px);max-height:80vh;display:grid;place-items:center;padding:10px}
.big-img{width:100%;max-height:70vh;object-fit:contain;border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.6),inset 0 0 0 2px rgba(255,255,255,.08);background:#061a2e}
.title{margin-top:14px;text-align:center;line-height:1.25;font-weight:800;letter-spacing:.5px;text-shadow:0 2px 8px rgba(0,0,0,.7)}
.title .line1{font-size:min(5.5vw,38px)}
.title .line2{font-size:min(5vw,34px);color:var(--accent)}
.actions{display:flex;gap:10px;margin-top:16px}
.actions .btn{background:#ffd34d;color:#1e2125;border-color:#c9a43c;font-weight:700}
.small{opacity:.85}
.status{font-size:12px;opacity:.9}
</style>
</head>
<body>
<header>
  <div style="font-weight:800">Jigsaw Puzzle Malaysia Ke-68</div>
  <div class="controls">
    <label class="file">Gambar <input id="imgInput" type="file" accept="image/*"></label>

    <select id="piecesSel" class="select" title="Bilangan petak">
      <option value="6">6 (2×3)</option><option value="8">8 (2×4)</option>
      <option value="10">10 (2×5)</option><option value="12" selected>12 (3×4)</option>
      <option value="16">16 (4×4)</option><option value="20">20 (4×5)</option>
      <option value="24">24 (3×8)</option>
    </select>

    <button id="startBtn" class="btn">Mula Puzzle</button>
    <button id="shuffleBtn" class="btn">Kacau</button>
    <button id="previewBtn" class="toggle">Preview</button>
    <button id="fsBtn" class="btn">Skrin Penuh</button>

    <!-- Muzik kemenangan -->
    <label class="file">Muzik MP3
      <input id="mp3Input" type="file" accept="audio/mpeg,audio/mp3,audio/mp4,audio/aac,audio/x-m4a,audio/wav,audio/ogg">
    </label>
    <span id="mp3Name" class="small"></span>
    <div class="range">Vol Muzik <input id="volRange" type="range" min="0" max="1" step="0.05" value="0.8"></div>

    <!-- SFX Snap -->
    <label class="file">Bunyi Snap
      <input id="sfxInput" type="file" accept="audio/wav,audio/x-wav,audio/mpeg,audio/mp3,audio/ogg,audio/*">
    </label>
    <span id="sfxName" class="status"></span>
    <div class="range">Vol Snap <input id="sfxVol" type="range" min="0" max="1" step="0.05" value="0.9"></div>
  </div>
</header>

<main>
  <section id="stage" class="stage">
    <canvas id="board"></canvas>

    <!-- Paparan kemenangan -->
    <div id="celebrate" aria-live="polite">
      <div class="big-wrap">
        <img id="celebrateImg" class="big-img" alt="Gambar kemenangan">
      </div>
      <div class="title">
        <div class="line1">SELAMAT MENYAMBUT BULAN KEBANGSAAN KE-68</div>
        <div class="line2">SK BUKIT TONGKAT</div>
      </div>
      <div class="actions">
        <button id="againBtn" class="btn">Main Lagi</button>
      </div>
    </div>
  </section>
</main>

<div id="toast" class="toast"></div>
<footer>Auto: bunyi snap (mp3/wav) bila tepat & lagu kemenangan bila gambar besar muncul.</footer>

<!-- Audio tersembunyi -->
<audio id="bgm" preload="auto" playsinline style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0"></audio>
<audio id="sfxEl" preload="auto" playsinline style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0"></audio>

<script>
/* ===== util ===== */
const $=s=>document.querySelector(s);
function toast(m){const t=$("#toast");t.textContent=m;t.style.display='block';setTimeout(()=>t.style.display='none',1600);}
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));

/* ===== canvas & layout ===== */
const stageEl=$("#stage");
const board=$("#board");
const ctx=board.getContext("2d",{alpha:false});
let W=0,H=0,DPR=Math.max(1,window.devicePixelRatio||1);
function resizeCanvas(){
  const pad=10, w=stageEl.clientWidth, h=Math.max(660,stageEl.clientHeight);
  W=w-pad; H=h-pad;
  board.style.left=(pad/2)+"px"; board.style.top=(pad/2)+"px";
  board.style.width=W+"px"; board.style.height=H+"px";
  board.width=Math.floor(W*DPR); board.height=Math.floor(H*DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
  draw(); // lukis papan kosong/tray
}
window.addEventListener("resize",()=>{ resizeCanvas(); if(img && built) buildPuzzle(); });

/* ===== state ===== */
let img=null;              // imej sumber
let rows=3, cols=4;        // konfigurasi grid
let pieces=[];             // senarai kepingan
let targets=[];            // posisi sasaran grid
let OX=0, OY=0, CELL=0;    // offset grid & saiz sel
let GRID_W=0, GRID_H=0;    // dimensi grid
let dragging=null, offX=0, offY=0;
let showPreview=false, built=false;
let trayW=0, margin=14, gutter=10;
const GRID_GAP=0;

/* ===== Muzik kemenangan ===== */
const bgm=$("#bgm"); let mp3URL=null;
$("#volRange").addEventListener("input", e => bgm.volume=+e.target.value);
bgm.volume=+$("#volRange").value;
$("#mp3Input").addEventListener("change", e=>{
  const f=e.target.files?.[0]; if(!f){ toast("Tiada fail muzik dipilih."); return; }
  try{
    if(mp3URL) URL.revokeObjectURL(mp3URL);
    mp3URL = URL.createObjectURL(f);
    bgm.src = mp3URL; bgm.load(); bgm.loop=true;
    $("#mp3Name").textContent = "• " + f.name;
    toast("Muzik kemenangan dimuat naik.");
  }catch{ toast("Gagal memuat muzik."); }
});

/* ===== SFX Snap (WebAudio + fallback) ===== */
let audioCtx=null, snapBuffer=null, sfxVol=0.9;
let sfxMode='default'; // 'buffer' | 'element' | 'default'
let sfxURL=null;
const sfxEl=$("#sfxEl");
function ensureAudioCtx(){ if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
function resumeCtx(){ if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); }
function makeDefaultSnapBuffer(){
  ensureAudioCtx();
  const dur=0.10, rate=audioCtx.sampleRate, len=Math.floor(dur*rate);
  const buf=audioCtx.createBuffer(1,len,rate);
  const data=buf.getChannelData(0);
  for(let i=0;i<len;i++){ const t=i/len; data[i]=(Math.random()*2-1)*Math.pow(1-t,5)*0.7; }
  return buf;
}
function playSnap(){
  // cuba WebAudio dahulu
  if(sfxMode==='buffer' && snapBuffer && audioCtx){
    resumeCtx();
    const src=audioCtx.createBufferSource(); src.buffer=snapBuffer;
    const g=audioCtx.createGain(); g.gain.value=sfxVol;
    src.connect(g).connect(audioCtx.destination); src.start();
    return;
  }
  // fallback <audio>
  if(sfxMode==='element' && sfxURL){
    const a=new Audio(sfxURL); a.volume=sfxVol; a.play().catch(()=>{});
    return;
  }
  // default noise
  ensureAudioCtx(); resumeCtx();
  if(!snapBuffer) snapBuffer=makeDefaultSnapBuffer();
  const src=audioCtx.createBufferSource(); src.buffer=snapBuffer;
  const g=audioCtx.createGain(); g.gain.value=sfxVol;
  src.connect(g).connect(audioCtx.destination); src.start();
  sfxMode='default';
}
$("#sfxVol").addEventListener("input",e=>{ sfxVol=+e.target.value; sfxEl.volume=sfxVol; });
$("#sfxInput").addEventListener("change",async (e)=>{
  const f=e.target.files?.[0]; if(!f){ $("#sfxName").textContent=""; sfxMode='default'; return; }
  $("#sfxName").textContent="• Memuat SFX…";
  try{
    // sediakan URL fallback
    if(sfxURL) URL.revokeObjectURL(sfxURL);
    sfxURL = URL.createObjectURL(f);
    sfxEl.src=sfxURL; sfxEl.load(); sfxEl.volume=sfxVol;

    // cuba decode ke WebAudio
    ensureAudioCtx();
    const arr=await f.arrayBuffer();
    const buf=await audioCtx.decodeAudioData(arr);
    snapBuffer=buf; sfxMode='buffer';
    $("#sfxName").textContent="• Bunyi snap siap (WebAudio)";
    toast("SFX snap dimuat (kualiti tinggi).");
  }catch(err){
    console.warn('SFX decode gagal, guna fallback audio element', err);
    snapBuffer=null; sfxMode='element';
    $("#sfxName").textContent="• Bunyi snap siap (Fallback)";
    toast("SFX guna fallback — masih berbunyi.");
  }
});

/* ===== controls ===== */
const mapping={6:[2,3],8:[2,4],10:[2,5],12:[3,4],16:[4,4],20:[4,5],24:[3,8]};
$("#piecesSel").addEventListener("change",e=>{
  const v=+e.target.value; rows=mapping[v][0]; cols=mapping[v][1]; if(img) buildPuzzle();
});
$("#previewBtn").addEventListener("click",function(){ showPreview=!showPreview; this.classList.toggle("active",showPreview); draw(); });
$("#startBtn").addEventListener("click",()=>{ if(!img) return toast("Muat naik gambar dahulu."); buildPuzzle(); });
$("#shuffleBtn").addEventListener("click",()=>shuffle());

$("#imgInput").addEventListener("change",e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    img=new Image();
    img.onload=()=>{ $("#celebrateImg").src=img.src; buildPuzzle(); };
    img.src=ev.target.result;
  };
  r.readAsDataURL(f);
});

/* ===== fullscreen ===== */
function isFS(){return document.fullscreenElement||document.webkitFullscreenElement;}
$("#fsBtn").addEventListener("click",()=>{
  try{
    if(!isFS()){ const el=stageEl; (el.requestFullscreen||el.webkitRequestFullscreen).call(el); $("#fsBtn").textContent="Keluar Skrin Penuh"; }
    else{ (document.exitFullscreen||document.webkitExitFullscreen).call(document); $("#fsBtn").textContent="Skrin Penuh"; }
  }catch(e){}
});
document.addEventListener("fullscreenchange",()=>$("#fsBtn").textContent=isFS()?"Keluar Skrin Penuh":"Skrin Penuh");

/* ===== helper ===== */
function rectPath(c,x,y,w,h){ c.beginPath(); c.rect(x,y,w,h); c.closePath(); }

/* ===== bina puzzle (grid besar + tray kiri/kanan) ===== */
function buildPuzzle(){
  pieces=[]; targets=[]; built=true;

  const usableH = H - margin*2;
  const minTrayFrac = 0.10, maxTrayFrac = 0.22;
  const pad=10, gap=8;

  let tw = Math.max(Math.round(W*minTrayFrac), 84);
  for(let i=0;i<4;i++){
    const usableW = W - margin*2 - 2*tw - 2*gutter;
    const cellW = Math.floor(usableW/cols);
    const cellH = Math.floor(usableH/rows);
    CELL = Math.max(48, Math.min(cellW, cellH));

    const half = Math.ceil((rows*cols)/2);
    const rmax = Math.max(1, Math.floor((H - margin*2 - pad*2)/(CELL+gap)));
    const colsNeed = Math.max(1, Math.ceil(half/rmax));
    const needW = pad*2 + colsNeed*CELL + (colsNeed-1)*gap;
    const newTW = clamp(Math.max(tw, needW), Math.round(W*minTrayFrac), Math.round(W*maxTrayFrac));
    if(Math.abs(newTW - tw) < 2) { tw=newTW; break; }
    tw=newTW;
  }
  trayW = tw;

  const usableW2 = W - margin*2 - 2*trayW - 2*gutter;
  CELL = Math.max(48, Math.min(Math.floor(usableW2/cols), Math.floor(usableH/rows)));
  GRID_W = CELL*cols; GRID_H = CELL*rows;
  OX = Math.round(margin + trayW + gutter + ( (W - 2*(trayW+gutter) - margin*2) - GRID_W )/2);
  OY = Math.round(margin + (usableH - GRID_H)/2);

  const sW = img.width/cols, sH = img.height/rows;
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const tx = OX + c*CELL;
      const ty = OY + r*CELL;
      const sx = c*sW, sy=r*sH;

      const can=document.createElement('canvas'); can.width=CELL*2; can.height=CELL*2;
      const g=can.getContext('2d'); g.scale(2,2); g.imageSmoothingEnabled=true; g.imageSmoothingQuality='high';

      rectPath(g,0,0,CELL,CELL); g.clip();
      g.drawImage(img, sx, sy, sW, sH, 0,0, CELL, CELL);

      pieces.push({r,c,x:tx,y:ty,w:CELL,h:CELL,img:can,at:{x:0,y:0},placed:false});
      targets.push({x:tx,y:ty,r,c});
    }
  }
  shuffle();
  draw(); // pastikan kelihatan selepas build
}

/* ===== letak kepingan di tray kiri/kanan ===== */
function shuffle(){
  if(!built || !pieces.length){ draw(); return; }
  const pad=10, gap=8;
  const total=pieces.length, leftCount=Math.ceil(total/2), rightCount=total-leftCount;
  const rmax = Math.max(1, Math.floor((H - margin*2 - pad*2) / (CELL + gap)));
  const colsLeft  = Math.max(1, Math.ceil(leftCount  / rmax));
  const colsRight = Math.max(1, Math.ceil(rightCount / rmax));
  const leftX  = Math.round(margin);
  const rightX = Math.round(W - margin - trayW);

  let i=0;
  for(; i<leftCount; i++){
    const c = i % colsLeft, r = Math.floor(i / colsLeft);
    pieces[i].at.x = leftX + pad + c*(CELL+gap);
    pieces[i].at.y = Math.round(margin + pad + r*(CELL+gap));
    pieces[i].placed=false;
  }
  for(let k=0; k<rightCount; k++){
    const idx=i+k, c=k % colsRight, r=Math.floor(k/colsRight);
    pieces[idx].at.x = rightX + pad + c*(CELL+gap);
    pieces[idx].at.y = Math.round(margin + pad + r*(CELL+gap));
    pieces[idx].placed=false;
  }
}

/* ===== lukis papan & kepingan ===== */
function draw(){
  // latar
  ctx.fillStyle='#071a2f'; ctx.fillRect(0,0,W,H);

  // tray kiri/kanan
  drawTray(Math.round(margin),Math.round(margin),Math.round(trayW),H-margin*2);
  drawTray(Math.round(W-margin-trayW),Math.round(margin),Math.round(trayW),H-margin*2);

  // grid tengah
  ctx.save(); ctx.fillStyle='#061a2e'; ctx.strokeStyle='rgba(255,255,255,.10)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.rect(OX-8||0, OY-8||0, (GRID_W||0)+16, (GRID_H||0)+16); ctx.fill(); ctx.stroke(); ctx.restore();

  if(showPreview && img && GRID_W>0 && GRID_H>0){
    ctx.save(); ctx.globalAlpha=0.28;
    ctx.drawImage(img,0,0,img.width,img.height, OX,OY, GRID_W,GRID_H);
    ctx.restore();
  }

  // kepingan di tray
  for(const p of pieces){ if(p===dragging || p.placed) continue; drawPiece(p,true); }
  // kepingan drag
  if(dragging) drawPiece(dragging,true,true);
  // kepingan yang sudah ditempatkan (dilukis terakhir supaya 'di bawah' outline)
  for(const p of pieces){ if(!p.placed || p===dragging) continue; drawPiece(p,false); }
}
function drawTray(x,y,w,h){
  ctx.save(); ctx.fillStyle='rgba(11,42,74,.96)'; ctx.strokeStyle='rgba(255,255,255,.08)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.rect(x,y,w,h); ctx.fill(); ctx.stroke(); ctx.restore();
}
function drawPiece(p,floating,lift){
  if(floating){
    ctx.save(); if(lift){ ctx.shadowColor='rgba(0,0,0,.35)'; ctx.shadowBlur=12; ctx.shadowOffsetY=6; }
    ctx.drawImage(p.img, Math.round(p.at.x), Math.round(p.at.y), p.w, p.h); ctx.restore();

    ctx.save(); ctx.lineWidth=Math.max(1.1,p.w*0.04); ctx.strokeStyle='rgba(255,255,255,.95)';
    rectPath(ctx, Math.round(p.at.x), Math.round(p.at.y), p.w, p.h); ctx.stroke(); ctx.restore();

    ctx.save(); ctx.lineWidth=1; ctx.strokeStyle='rgba(0,0,0,.20)';
    rectPath(ctx, Math.round(p.at.x), Math.round(p.at.y), p.w, p.h); ctx.stroke(); ctx.restore();
  }else{
    ctx.drawImage(p.img, Math.round(p.x), Math.round(p.y), p.w, p.h);
  }
}

/* ===== DnD + snap ===== */
function pieceAt(px,py){
  for(let i=pieces.length-1;i>=0;i--){
    const p=pieces[i], x=p.at.x, y=p.at.y, w=p.w, h=p.h;
    if(px>=x && px<=x+w && py>=y && py<=y+h) return p;
  } return null;
}
board.addEventListener("pointerdown",e=>{
  e.preventDefault();
  try{ board.setPointerCapture(e.pointerId); }catch(_){}
  try{ ensureAudioCtx(); resumeCtx(); }catch(_){}
  const r=board.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
  const p=pieceAt(x,y); if(!p) return;
  dragging=p; offX=x-p.at.x; offY=y-p.at.y;
  const i=pieces.indexOf(p); pieces.push(pieces.splice(i,1)[0]);
  requestAnimationFrame(draw);
},{passive:false});

board.addEventListener("pointermove",e=>{
  if(!dragging) return; e.preventDefault();
  const r=board.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
  dragging.at.x=x-offX; dragging.at.y=y-offY; requestAnimationFrame(draw);
},{passive:false});

board.addEventListener("pointerup",e=>{
  if(!dragging) return; e.preventDefault();
  const p=dragging; dragging=null;

  const snap=findNearestTarget(p.at.x+p.w/2, p.at.y+p.h/2);
  if(snap && !occupied(snap.r,snap.c)){
    p.at.x=snap.x; p.at.y=snap.y;
    p.placed=(p.x===snap.x && p.y===snap.y);
    if(p.placed) playSnap(); // bunyi snap bila tepat
  }
  draw(); checkWin();
},{passive:false});

function findNearestTarget(cx,cy){
  if(GRID_W<=0 || GRID_H<=0) return null;
  if(cx>=OX && cx<=OX+GRID_W && cy>=OY && cy<=OY+GRID_H){
    const c=Math.floor((cx-OX)/CELL), r=Math.floor((cy-OY)/CELL);
    if(r>=0 && r<rows && c>=0 && c<cols) return targets[r*cols+c];
  }
  return null;
}
function occupied(rr,cc){ return pieces.some(p=>p.placed && p.r===rr && p.c===cc); }

/* ===== MENANG: gambar besar + auto muzik ===== */
function checkWin(){
  for(const p of pieces){ if(!(p.at.x===p.x && p.at.y===p.y)) return; }
  $("#celebrateImg").src = img?.src || "";
  $("#celebrate").classList.add("show");
  if(bgm.src){
    try{
      bgm.currentTime=0; bgm.loop=true;
      const pr=bgm.play();
      if(pr && typeof pr.then==="function"){ pr.catch(()=>{}); }
    }catch(_){}
  }
}

/* ===== semula ===== */
$("#againBtn").addEventListener("click",()=>{ $("#celebrate").classList.remove("show"); shuffle(); draw(); });

/* ===== mula ===== */
resizeCanvas(); // sediakan kanvas
// Jika nak papar grid kosong walaupun belum ada gambar, boleh letak img placeholder.

</script>
</body>
</html>
