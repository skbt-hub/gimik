<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Jigsaw Puzzle Malaysia — Grid Rapat + Tray</title>
<style>
:root{
  --bg:#0a2540; --panel:#0f3359; --line:#0b2846; --text:#eaf3ff; --accent:#ffd34d;
  --grid:#123e70; --tray:#0b2a4a;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 16px;background:linear-gradient(180deg,#123e70,#0f3359);border-bottom:2px solid var(--line)}
.controls{display:flex;flex-wrap:wrap;gap:8px}
.btn,.select,.file,.range{background:var(--panel);color:var(--text);border:1px solid #1a4d82;border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
.btn:hover{background:#134674}
.file input[type=file]{border:none;padding:0}
.range{display:flex;align-items:center;gap:8px}
.range input{accent-color:#ffd34d}
main{padding:12px}
.stage{
  position:relative;border:2px solid var(--line);border-radius:14px;min-height:72vh;overflow:hidden;touch-action:none;
  background:
    radial-gradient(ellipse at center, rgba(0,0,0,.32), rgba(0,0,0,0) 60%) center/140% 140% no-repeat,
    url('data:image/svg+xml;utf8,\
    <svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120">\
      <filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2"/></filter>\
      <rect width="120" height="120" fill="#2b3542"/>\
      <rect width="120" height="120" filter="url(%23n)" opacity=".12"/>\
    </svg>') repeat;
}
canvas{position:absolute;inset:0}
.toggle{background:var(--panel);border:1px solid #1a4d82;border-radius:999px;padding:6px 10px}
.toggle.active{background:var(--accent);color:#222;border-color:#c9a43c;font-weight:700}
#win{position:absolute;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;gap:10px;background:rgba(0,0,0,.65);color:#fff}
.toast{position:fixed;left:50%;top:14px;transform:translateX(-50%);background:#123e70;color:#fff;border:1px solid #1a4d82;border-radius:10px;padding:8px 12px;display:none;z-index:9}
footer{padding:10px 16px;color:#b8d3f0;font-size:12px}

/* Tray info */
.badge{position:absolute;left:16px;right:16px;bottom:14px;display:flex;justify-content:center;pointer-events:none;font-size:12px;color:#b8d3f0}
</style>
</head>
<body>
<header>
  <div style="font-weight:800">Jigsaw Puzzle Malaysia Ke-68</div>
  <div class="controls">
    <label class="file">Gambar <input id="imgInput" type="file" accept="image/*"></label>

    <select id="piecesSel" class="select" title="Bilangan petak">
      <option value="6">6 (2×3)</option>
      <option value="8">8 (2×4)</option>
      <option value="10">10 (2×5)</option>
      <option value="12" selected>12 (3×4)</option>
      <option value="16">16 (4×4)</option>
      <option value="20">20 (4×5)</option>
      <option value="24">24 (3×8)</option>
    </select>

    <button id="startBtn" class="btn">Mula Puzzle</button>
    <button id="shuffleBtn" class="btn">Kacau</button>
    <button id="previewBtn" class="toggle">Preview</button>
    <button id="fsBtn" class="btn">Skrin Penuh</button>

    <!-- Muzik MP3 -->
    <label class="file">Muzik MP3 <input id="mp3Input" type="file" accept="audio/mpeg,audio/mp3,audio/*"></label>
    <button id="musicPlay" class="btn">Main Muzik</button>
    <button id="musicPause" class="btn">Henti Muzik</button>
    <div class="range">Volum <input id="volRange" type="range" min="0" max="1" step="0.05" value="0.7"></div>
    <button id="autoMusicBtn" class="toggle">Auto Muzik: Mati</button>
  </div>
</header>

<main>
  <section id="stage" class="stage">
    <canvas id="board"></canvas>
    <div id="win">
      <h3 style="margin:0">TAHNIAH ANDA BERJAYA!</h3>
      <p style="margin:0">SELAMAT MENYAMBUT BULAN KEBANGSAAN KE-68.</p>
      <button id="againBtn" class="btn">Main Lagi</button>
    </div>
    <div class="badge">Seret kepingan dari <strong>Tray</strong> (bahagian bawah) ke dalam kotak.</div>
  </section>
</main>

<div id="toast" class="toast"></div>
<footer>Petak grid rapat (tiada jarak). Semua kepingan bermula di Tray. Lepaskan berhampiran petak untuk snap tepat.</footer>

<audio id="bgm" preload="auto"></audio>

<script>
/* ===== util ===== */
const $=s=>document.querySelector(s);
function toast(m){const t=$("#toast");t.textContent=m;t.style.display='block';setTimeout(()=>t.style.display='none',1600);}

/* ===== canvas ===== */
const stageEl=$("#stage");
const board=$("#board"), ctx=board.getContext("2d",{alpha:false});
let W=0,H=0,DPR=Math.max(1,window.devicePixelRatio||1);
function resizeCanvas(){
  const pad=12, w=stageEl.clientWidth, h=Math.max(560,stageEl.clientHeight);
  W=w-pad; H=h-pad;
  board.style.left=(pad/2)+"px"; board.style.top=(pad/2)+"px";
  board.style.width=W+"px"; board.style.height=H+"px";
  board.width=Math.floor(W*DPR); board.height=Math.floor(H*DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
  draw();
}
addEventListener("resize",()=>{ resizeCanvas(); if(img && built) buildPuzzle(); });

/* ===== state ===== */
let img=null;
let rows=3, cols=4, pieces=[], targets=[];
let OX=0, OY=0, CELL=0, GRID_W=0, GRID_H=0;
let dragging=null, offX=0, offY=0, showPreview=false, built=false;
let trayY=0, trayH=0; // kawasan tray bawah
const GRID_GAP=0;     // Rapat! tiada jarak antara petak

/* ===== audio ===== */
const bgm=$("#bgm");
let autoMusic=false;
$("#volRange").addEventListener("input", e => bgm.volume=+e.target.value);
bgm.volume=+$("#volRange").value;
$("#mp3Input").addEventListener("change", e=>{
  const f=e.target.files[0]; if(!f) return;
  bgm.src=URL.createObjectURL(f);
  toast("Muzik dimuat naik.");
});
$("#musicPlay").onclick=()=>{ if(!bgm.src) return toast("Muat naik MP3 dahulu."); bgm.loop=true; bgm.play().catch(()=>toast("Tekan sekali lagi untuk benarkan audio.")); };
$("#musicPause").onclick=()=>bgm.pause();
$("#autoMusicBtn").onclick=function(){ autoMusic=!autoMusic; this.textContent="Auto Muzik: "+(autoMusic?"Hidup":"Mati"); this.classList.toggle("active",autoMusic); };

/* ===== uploads & controls ===== */
$("#imgInput").addEventListener("change",e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{ img=new Image(); img.onload=()=>{ toast("Gambar dimuat naik."); buildPuzzle(); }; img.src=ev.target.result; };
  r.readAsDataURL(f);
});
const mapping={6:[2,3],8:[2,4],10:[2,5],12:[3,4],16:[4,4],20:[4,5],24:[3,8]};
$("#piecesSel").onchange=e=>{ const v=+e.target.value; rows=mapping[v][0]; cols=mapping[v][1]; if(img) buildPuzzle(); };
$("#previewBtn").onclick=function(){ showPreview=!showPreview; this.classList.toggle("active",showPreview); draw(); };
$("#startBtn").onclick=()=>{ if(!img) return toast("Muat naik gambar dahulu."); buildPuzzle(); bgm.play().catch(()=>{}); };
$("#shuffleBtn").onclick=()=>shuffle();

/* ===== fullscreen ===== */
function isFS(){return document.fullscreenElement||document.webkitFullscreenElement;}
$("#fsBtn").onclick=()=>{
  try{
    if(!isFS()){
      const el=stageEl; (el.requestFullscreen||el.webkitRequestFullscreen).call(el);
      $("#fsBtn").textContent="Keluar Skrin Penuh";
    }else{
      (document.exitFullscreen||document.webkitExitFullscreen).call(document);
      $("#fsBtn").textContent="Skrin Penuh";
    }
  }catch(e){}
};
document.addEventListener("fullscreenchange",()=>$("#fsBtn").textContent=isFS()?"Keluar Skrin Penuh":"Skrin Penuh");

/* ===== bina puzzle (grid rapat + tray bawah) ===== */
function buildPuzzle(){
  pieces=[]; targets=[]; built=true;

  // ruang grid (atas), tray (bawah)
  const margin=18, trayMin=150;
  const usableW=W-margin*2, usableH=H-margin*2;
  // perkadaran: 72% grid, 28% tray (min 150px)
  trayH=Math.max(trayMin, Math.round(usableH*0.28));
  trayY=H - margin - trayH;
  const gridH = usableH - trayH - 12; // 12px ruang antara grid & tray
  const gridW = usableW;

  // kira saiz sel (petak empat segi tepat, rapat)
  CELL = Math.floor(Math.min(gridW/cols, gridH/rows));
  GRID_W = CELL*cols + GRID_GAP*(cols-1);
  GRID_H = CELL*rows + GRID_GAP*(rows-1);
  OX = Math.round((W-GRID_W)/2);
  OY = Math.round(margin + (gridH - GRID_H)/2);

  // potong imej ke kepingan petak
  const sW = img.width/cols, sH = img.height/rows;

  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      const tx = OX + c*(CELL+GRID_GAP);
      const ty = OY + r*(CELL+GRID_GAP);
      const sx = c*sW, sy=r*sH;

      // buat kanvas kepingan
      const can=document.createElement('canvas');
      can.width = CELL*2; can.height=CELL*2; // HiDPI
      const g=can.getContext('2d');
      g.scale(2,2); g.imageSmoothingEnabled=true; g.imageSmoothingQuality='high';

      // bingkai lembut
      const radius = Math.max(6, CELL*0.06);
      g.save();
      g.beginPath();
      roundedRect(g, 0,0, CELL, CELL, radius);
      g.clip();
      g.drawImage(img, sx, sy, sW, sH, 0,0, CELL, CELL);
      g.restore();

      // stroke hanya ketika terapung (dilukis dalam draw)
      pieces.push({
        r, c,
        x: tx, y: ty, // target (untuk kemenangan)
        w: CELL, h: CELL,
        img: can,
        at:{x:0,y:0}, // lokasi semasa (diisi ketika shuffle)
        placed:false
      });
      targets.push({x:tx,y:ty,r,c});
    }
  }
  shuffle();
}

function roundedRect(c,x,y,w,h,r){
  const rr=Math.min(r, w/2, h/2);
  c.moveTo(x+rr,y);
  c.arcTo(x+w,y, x+w,y+h, rr);
  c.arcTo(x+w,y+h, x,y+h, rr);
  c.arcTo(x,y+h, x,y, rr);
  c.arcTo(x,y, x+w,y, rr);
  c.closePath();
}

/* ===== susun ke tray ===== */
function shuffle(){
  if(!built) return;
  // letak semua kepingan rawak di tray (bawah)
  const pad=12;
  const colsTray = Math.max(1, Math.floor((W - pad*2) / (CELL + 8)));
  let cx=0, cy=0;
  for(const p of pieces){
    const col = cx % colsTray;
    const row = Math.floor(cx / colsTray);
    const px = pad + col*(CELL+8);
    const py = trayY + pad + row*(CELL+8);
    p.at.x = px;
    p.at.y = py;
    p.placed=false;
    cx++;
  }
  draw();
}

/* ===== lukis ===== */
function draw(){
  // latar papan
  ctx.fillStyle= '#071a2f';
  ctx.fillRect(0,0,W,H);

  // grid area
  ctx.save();
  ctx.fillStyle = '#061a2e';
  ctx.strokeStyle = 'rgba(255,255,255,.08)';
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.rect(OX-8, OY-8, GRID_W+16, GRID_H+16); ctx.fill(); ctx.stroke();
  ctx.restore();

  // preview dalam grid
  if(showPreview && img){
    ctx.save(); ctx.globalAlpha=0.25; ctx.drawImage(img, 0,0,img.width,img.height, OX,OY, GRID_W,GRID_H); ctx.restore();
  }

  // garisan halus antara petak (boleh set ke 0 untuk betul2 rapat)
  if(GRID_GAP>0){
    ctx.save();
    ctx.strokeStyle='rgba(255,255,255,.06)';
    ctx.lineWidth=GRID_GAP;
    for(let i=1;i<cols;i++){
      const x=OX+i*CELL + (i-1)*GRID_GAP + GRID_GAP/2;
      ctx.beginPath(); ctx.moveTo(x,OY); ctx.lineTo(x,OY+GRID_H); ctx.stroke();
    }
    for(let j=1;j<rows;j++){
      const y=OY+j*CELL + (j-1)*GRID_GAP + GRID_GAP/2;
      ctx.beginPath(); ctx.moveTo(OX,y); ctx.lineTo(OX+GRID_W,y); ctx.stroke();
    }
    ctx.restore();
  }

  // tray bawah
  ctx.save();
  ctx.fillStyle= 'rgba(11,42,74,.95)';
  ctx.strokeStyle='rgba(255,255,255,.08)';
  ctx.lineWidth=1;
  ctx.beginPath(); ctx.rect(10, trayY, W-20, trayH-6); ctx.fill(); ctx.stroke();
  ctx.restore();

  // lukis semua kepingan: yang belum placed (dengan stroke) → dragging → placed (tanpa stroke)
  for(const p of pieces){
    if(p===dragging || p.placed) continue;
    drawPiece(p, true);
  }
  if(dragging) drawPiece(dragging, true, true);
  for(const p of pieces){
    if(!p.placed || p===dragging) continue;
    drawPiece(p, false);
  }
}

function drawPiece(p, floating, lift){
  const x = (p===dragging? p.at.x : p.at.x);
  const y = (p===dragging? p.at.y : p.at.y);
  if(floating){
    // bayang & stroke putih halus ketika di luar grid
    ctx.save();
    if(lift){ ctx.shadowColor='rgba(0,0,0,.35)'; ctx.shadowBlur=12; ctx.shadowOffsetY=6; }
    ctx.drawImage(p.img, Math.round(x), Math.round(y), p.w, p.h);
    ctx.restore();

    ctx.save();
    ctx.lineWidth=Math.max(1.2, p.w*0.04);
    ctx.strokeStyle='rgba(255,255,255,.95)';
    ctx.beginPath(); roundedRect(ctx, Math.round(x), Math.round(y), p.w, p.h, Math.max(6,p.w*0.06)); ctx.stroke();
    ctx.restore();

    ctx.save();
    ctx.lineWidth=1; ctx.strokeStyle='rgba(0,0,0,.22)';
    ctx.beginPath(); roundedRect(ctx, Math.round(x), Math.round(y), p.w, p.h, Math.max(6,p.w*0.06)); ctx.stroke();
    ctx.restore();
  }else{
    // dalam grid: tiada stroke, rapat
    ctx.drawImage(p.img, Math.round(p.x), Math.round(p.y), p.w, p.h);
  }
}

/* ===== DnD + snap dalam grid ===== */
function pieceAt(px,py){
  for(let i=pieces.length-1;i>=0;i--){
    const p=pieces[i], x=p.at.x, y=p.at.y, w=p.w, h=p.h;
    if(px>=x && px<=x+w && py>=y && py<=y+h) return p;
  } return null;
}
board.addEventListener("pointerdown",e=>{
  e.preventDefault();
  try{ board.setPointerCapture(e.pointerId); }catch(_){}
  const r=board.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
  const p=pieceAt(x,y); if(!p) return;
  dragging=p; offX=x-p.at.x; offY=y-p.at.y;
  const i=pieces.indexOf(p); pieces.push(pieces.splice(i,1)[0]); requestAnimationFrame(draw);
},{passive:false});

board.addEventListener("pointermove",e=>{
  if(!dragging) return; e.preventDefault();
  const r=board.getBoundingClientRect(), x=e.clientX-r.left, y=e.clientY-r.top;
  dragging.at.x = x-offX; dragging.at.y = y-offY;
  requestAnimationFrame(draw);
},{passive:false});

board.addEventListener("pointerup",e=>{
  if(!dragging) return; e.preventDefault();
  const p=dragging; dragging=null;

  // jika dilepaskan berhampiran mana2 petak target → snap tepat
  const snap = findNearestTarget(p.at.x + p.w/2, p.at.y + p.h/2);
  if(snap && !occupied(snap.r, snap.c)){
    p.at.x = snap.x; p.at.y = snap.y;
    p.placed = (p.x===snap.x && p.y===snap.y);
  }
  draw(); checkWin();
},{passive:false});

function findNearestTarget(cx,cy){
  // cepat: jika pointer berada dalam area grid, terus kira indeks
  if(cx>=OX && cx<=OX+GRID_W && cy>=OY && cy<=OY+GRID_H){
    const c = Math.floor((cx - OX) / (CELL+GRID_GAP));
    const r = Math.floor((cy - OY) / (CELL+GRID_GAP));
    const idx = r*cols + c;
    return targets[idx];
  }
  // jika luar grid, pulangkan null
  return null;
}
function occupied(rr,cc){
  return pieces.some(p=>p.placed && p.r===rr && p.c===cc);
}

/* ===== menang ===== */
function checkWin(){
  for(const p of pieces){
    if(!(p.at.x===p.x && p.at.y===p.y)) return;
  }
  $("#win").style.display="flex";
  if(autoMusic && bgm.src){ bgm.currentTime=0; bgm.play().catch(()=>{}); }
}
$("#againBtn").onclick=()=>{ $("#win").style.display="none"; shuffle(); };

/* ===== init ===== */
resizeCanvas();
</script>
</body>
</html>
