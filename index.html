<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Puzzle Kebangsaan ‚Äî Jigsaw Klasik</title>
<style>
  :root{ --bg:#0a2540; --panel:#103d68; --accent:#ffd34d; --text:#eef6ff; --muted:#b8d3f0; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  header{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between;
    background:linear-gradient(180deg,#123e70,#0f3359);padding:10px 14px;border-bottom:2px solid #0b2846;position:sticky;top:0;z-index:5}
  .brand{font-weight:700;letter-spacing:.3px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .controls label{font-size:14px;color:var(--muted)}
  input[type=file],select,button{background:#0d2f53;border:1px solid #0a2745;color:var(--text);
    padding:8px 10px;border-radius:8px}
  button.primary{background:var(--accent);color:#0a2540;border:none;font-weight:700}
  #wrap{max-width:1400px;margin:14px auto;padding:0 14px}
  #boardWrap{position:relative;background:#07233f;border:2px solid #0b2a48;border-radius:12px;overflow:hidden}
  /* Responsif: papan kekalkan ratio dan sentiasa tengah */
  #board{position:relative;width:100%;aspect-ratio:16/9;min-height:60vh}
  /* Pratonton sentiasa di tengah, skala contain */
  #preview{position:absolute;inset:0;margin:auto;max-width:100%;max-height:100%;object-fit:contain;
    filter:drop-shadow(0 4px 12px rgba(0,0,0,.35));}
  /* Dulang (optional) */
  #tray{margin-top:10px;background:#0c2f54;border:2px dashed #17426c;border-radius:10px;padding:10px;display:flex;flex-wrap:wrap;gap:8px;align-content:flex-start;min-height:18vh}
  .piece{position:absolute;touch-action:none;cursor:grab;user-select:none}
  .muted{color:var(--muted);font-size:13px}
  #status{margin-top:6px}
  #toast{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.4);
    visibility:hidden;opacity:0;transition:.3s}
  #toast.show{visibility:visible;opacity:1}
  .card{background:#113b66;border:2px solid #174a7f;border-radius:14px;padding:22px;text-align:center;max-width:420px}
  .card h2{margin:.2em 0;color:var(--accent)}
  .small{font-size:12px;color:#cfe2ffaa}
  @media (max-width:920px){ #board{aspect-ratio:auto;min-height:66vh} }
</style>
</head>
<body>
<header>
  <div class="brand">üéè Selamat Menyambut Bulan Kebangsaan</div>
  <div class="controls">
    <label>Gambar <input id="imgInput" type="file" accept="image/*"></label>
    <label>MP3 <input id="mp3Input" type="file" accept="audio/*"></label>
    <label>Bil. kepingan
      <select id="piecesSelect">
        <option value="6">6 (3√ó2)</option>
        <option value="8">8 (4√ó2)</option>
        <option value="12" selected>12 (4√ó3)</option>
        <option value="16">16 (4√ó4)</option>
        <option value="20">20 (5√ó4)</option>
      </select>
    </label>
    <button id="btnGenerate" class="primary">Mula Puzzle</button>
    <button id="btnShuffle">Kacau</button>
    <button id="btnFS">Skrin Penuh</button>
    <button id="musicToggle">Bunyi: SEDIAKAN</button>
  </div>
</header>

<div id="wrap">
  <div id="boardWrap">
    <div id="board" aria-label="Papan puzzle">
      <img id="preview" alt="Pratonton gambar"/>
      <!-- kepingan akan diletak sebagai <canvas class="piece"> di sini -->
    </div>
  </div>
  <div id="tray"><div class="muted">Seret kepingan ke papan. Ia akan ‚Äúsnap‚Äù apabila tepat.</div><div id="status" class="muted"></div></div>
  <div class="muted" style="margin-top:8px">
    Tip iPad: selepas pilih MP3, tekan <b>Bunyi: SEDIAKAN</b> sekali (unlock audio), kemudian tekan <b>Mula Puzzle</b>.
  </div>
</div>

<audio id="bgm" loop preload="auto"></audio>
<audio id="fxWin" preload="auto">
  <source src="data:audio/mp3;base64,//uQZAAAAD/8AAAA..." type="audio/mp3">
</audio>

<div id="toast">
  <div class="card">
    <h2>üéâ Tahniah! Siap.</h2>
    <p>Hebat! Semua kepingan telah dipasang.</p>
    <p class="small">Tekan ‚ÄúKacau‚Äù untuk main lagi, atau muat naik gambar lain.</p>
    <div style="margin-top:12px;display:flex;gap:10px;justify-content:center">
      <button id="again" class="primary">Kacau</button>
      <button id="closeWin">Tutup</button>
    </div>
  </div>
</div>

<script>
/* ====== Ringkas: util & elemen ====== */
const $ = s=>document.querySelector(s);
const board=$("#board"), boardWrap=$("#boardWrap"), tray=$("#tray"), preview=$("#preview");
const imgInput=$("#imgInput"), mp3Input=$("#mp3Input"), piecesSelect=$("#piecesSelect");
const btnGenerate=$("#btnGenerate"), btnShuffle=$("#btnShuffle"), btnFS=$("#btnFS");
const statusEl=$("#status"), toast=$("#toast"), again=$("#again"), closeWin=$("#closeWin");
const bgm=$("#bgm"), fxWin=$("#fxWin"), musicToggle=$("#musicToggle");
let startedAudio=false, rows=0, cols=0, pieces=[], placed=0, srcImage=null;

/* ====== Audio unlock ====== */
musicToggle.onclick=()=>{ startedAudio=true; if(bgm.src) bgm.play().catch(()=>{}); };
mp3Input.addEventListener("change", e=>{
  const f=e.target.files?.[0]; if(!f) return;
  bgm.src = URL.createObjectURL(f);
});

/* ====== Fullscreen toggle (responsif) ====== */
function isFS(){ return document.fullscreenElement || document.webkitFullscreenElement; }
function enterFS(el){
  (el.requestFullscreen?.bind(el) || el.webkitRequestFullscreen?.bind(el) || el.msRequestFullscreen?.bind(el) || el.mozRequestFullScreen?.bind(el) || (()=>Promise.resolve()))();
}
function exitFS(){
  (document.exitFullscreen?.bind(document) || document.webkitExitFullscreen?.bind(document) || document.msExitFullscreen?.bind(document) || document.mozCancelFullScreen?.bind(document) || (()=>Promise.resolve()))();
}
btnFS.onclick=()=>{ isFS()? exitFS() : enterFS(boardWrap); };
document.addEventListener("fullscreenchange", ()=>{ if(srcImage) regenerate(); });
document.addEventListener("webkitfullscreenchange", ()=>{ if(srcImage) regenerate(); });

/* ====== Preview di tengah stage ====== */
imgInput.addEventListener("change", e=>{
  const file=e.target.files?.[0]; if(!file) return;
  const url=URL.createObjectURL(file);
  const img=new Image();
  img.onload=()=>{
    srcImage=img;
    preview.src=url;           // paparkan di tengah (object-fit: contain)
    // kosongkan puzzle sedia ada
    board.querySelectorAll(".piece").forEach(p=>p.remove());
    pieces=[]; placed=0; updateStatus();
  };
  img.src=url;
});

/* ====== Jigsaw generator (sama konsep versi sebelum ini) ====== */
function gridFor(n){
  if(n==6) return [2,3]; if(n==8) return [2,4]; if(n==12) return [3,4];
  if(n==16) return [4,4]; if(n==20) return [4,5]; return [3,4];
}
function buildEdgeMap(r,c){
  const map=Array.from({length:r},()=>Array.from({length:c},()=>({t:0,r:0,b:0,l:0})));
  const sign=()=>Math.random()>0.5?1:-1;
  for(let y=0;y<r;y++)for(let x=0;x<c;x++){
    const cell=map[y][x];
    if(y===0)cell.t=0; else cell.t=-map[y-1][x].b;
    if(x===0)cell.l=0; else cell.l=-map[y][x-1].r;
    if(y===r-1)cell.b=0; else cell.b=sign();
    if(x===c-1)cell.r=0; else cell.r=sign();
  }
  return map;
}
function edgePath(ctx,x1,y1,x2,y2,dir,sign,size){
  if(sign===0){ctx.lineTo(x2,y2);return;}
  const len=dir==='H'?(x2-x1):(y2-y1);
  const midx=x1+(dir==='H'?len/2:0), midy=y1+(dir==='V'?len/2:0);
  const tab=size*0.35, neck=size*0.15, bulge=tab*sign;
  if(dir==='H'){
    const vy=bulge;
    ctx.lineTo(x1+len*0.25,y1);
    ctx.bezierCurveTo(x1+len*0.25,y1,midx-neck,y1,midx-neck,y1);
    ctx.bezierCurveTo(midx-neck,y1,midx-neck,y1+vy,midx,y1+vy);
    ctx.bezierCurveTo(midx+neck,y1+vy,midx+neck,y1,midx+neck,y1);
    ctx.bezierCurveTo(midx+neck,y1,x1+len*0.75,y1,x1+len*0.75,y1);
    ctx.lineTo(x2,y2);
  }else{
    const vx=bulge;
    ctx.lineTo(x1,y1+len*0.25);
    ctx.bezierCurveTo(x1,y1+len*0.25,x1,midy-neck,x1,midy-neck);
    ctx.bezierCurveTo(x1,midy-neck,x1+vx,midy-neck,x1+vx,midy);
    ctx.bezierCurveTo(x1+vx,midy+neck,x1,midy+neck,x1,midy+neck);
    ctx.bezierCurveTo(x1,midy+neck,x1,y1+len*0.75,x1,y1+len*0.75);
    ctx.lineTo(x2,y2);
  }
}
function makePieces(img,r,c){
  // padam keping lama & sembunyi preview
  board.querySelectorAll(".piece").forEach(p=>p.remove());
  preview.style.display="none";

  const bw=board.clientWidth, bh=board.clientHeight;
  const ratio=Math.min(bw/img.width,bh/img.height);
  const W=Math.round(img.width*ratio), H=Math.round(img.height*ratio);
  const cellW=W/c, cellH=H/r, size=Math.min(cellW,cellH);
  const edges=buildEdgeMap(r,c);

  const src=document.createElement("canvas"); src.width=W; src.height=H;
  const sctx=src.getContext("2d"); sctx.drawImage(img,0,0,W,H);

  pieces=[]; placed=0; updateStatus();

  for(let y=0;y<r;y++)for(let x=0;x<c;x++){
    const cnv=document.createElement("canvas");
    cnv.width=Math.ceil(cellW+size*0.8); cnv.height=Math.ceil(cellH+size*0.8);
    const px=x*cellW, py=y*cellH, ox=size*0.4, oy=size*0.4;
    const ctx=cnv.getContext("2d"); ctx.translate(ox,oy);
    ctx.beginPath(); ctx.moveTo(0,0);
    edgePath(ctx,0,0,cellW,0,'H',edges[y][x].t,size);
    edgePath(ctx,cellW,0,cellW,cellH,'V',edges[y][x].r,size);
    edgePath(ctx,cellW,cellH,0,cellH,'H',-edges[y][x].b,size);
    edgePath(ctx,0,cellH,0,0,'V',-edges[y][x].l,size);
    ctx.closePath(); ctx.clip();
    ctx.drawImage(src,-px+ox,-py+oy); ctx.strokeStyle="rgba(0,0,0,.35)"; ctx.lineWidth=1.1; ctx.stroke();

    cnv.className="piece";
    cnv.style.left=(Math.random()*(bw-cnv.width))+"px";
    cnv.style.top =(Math.random()*(bh-cnv.height))+"px";
    cnv.dataset.tx = ( (bw-W)/2 + px - ox ); // target diletak di tengah papan
    cnv.dataset.ty = ( (bh-H)/2 + py - oy );
    enableDrag(cnv);
    board.appendChild(cnv);
    pieces.push({el:cnv});
  }
}
function enableDrag(el){
  let sx=0,sy=0,startL=0,startT=0,drag=false;
  const pd=e=>{drag=true; el.style.cursor="grabbing"; const r=el.getBoundingClientRect(); const b=board.getBoundingClientRect();
    sx=(e.touches?e.touches[0].clientX:e.clientX); sy=(e.touches?e.touches[0].clientY:e.clientY);
    startL=r.left-b.left; startT=r.top-b.top; e.preventDefault(); if(!startedAudio){startedAudio=true; bgm.play().catch(()=>{});} };
  const pm=e=>{ if(!drag) return; const x=(e.touches?e.touches[0].clientX:e.clientX), y=(e.touches?e.touches[0].clientY:e.clientY);
    el.style.left=(startL+(x-sx))+"px"; el.style.top=(startT+(y-sy))+"px"; };
  const pu=()=>{ if(!drag) return; drag=false; el.style.cursor="grab";
    const b=board.getBoundingClientRect(); const r=el.getBoundingClientRect();
    const x=r.left-b.left, y=r.top-b.top, tx=+el.dataset.tx, ty=+el.dataset.ty;
    if(Math.hypot(x-tx,y-ty)<18){ el.style.left=tx+"px"; el.style.top=ty+"px"; el.style.pointerEvents="none"; placed++; updateStatus(); if(placed===pieces.length) win(); }
  };
  el.addEventListener("pointerdown",pd); window.addEventListener("pointermove",pm); window.addEventListener("pointerup",pu);
}
function updateStatus(){ statusEl.textContent=`Siap: ${placed}/${pieces.length} keping`; }
function win(){ fxWin.currentTime=0; fxWin.play().catch(()=>{}); toast.classList.add("show"); }
again.onclick=()=>{ toast.classList.remove("show"); shuffle(); };
closeWin.onclick=()=> toast.classList.remove("show");

function generate(){
  if(!srcImage){ // tiada gambar: gunakan preview placeholder
    const c=document.createElement("canvas"); c.width=1240;c.height=1754;
    const cx=c.getContext("2d"); cx.fillStyle="#fff"; cx.fillRect(0,0,c.width,c.height);
    const img=new Image(); img.onload=()=>{ srcImage=img; regenerate(); }; img.src=c.toDataURL();
    return;
  }
  regenerate();
}
function regenerate(){
  const [r,c]=gridFor(+piecesSelect.value); rows=r; cols=c;
  makePieces(srcImage, r, c);
}
function shuffle(){
  placed=0; updateStatus();
  const b=board.getBoundingClientRect();
  pieces.forEach(p=>{
    const el=p.el;
    el.style.pointerEvents="auto";
    el.style.left=(Math.random()*(b.width-el.width))+"px";
    el.style.top =(Math.random()*(b.height-el.height))+"px";
  });
}

btnGenerate.onclick=generate;
btnShuffle.onclick=shuffle;

/* Gambar permulaan (SVG ringkas) supaya ada preview tengah */
(function initDefault(){
  const url="data:image/svg+xml;utf8,"+encodeURIComponent(
    `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 800'>
      <defs><linearGradient id='g' x1='0' x2='0' y1='0' y2='1'>
        <stop offset='0' stop-color='#e8f1ff'/><stop offset='1' stop-color='#cfe3ff'/></linearGradient></defs>
      <rect fill='url(#g)' width='1200' height='800'/>
      <text x='600' y='360' font-size='56' text-anchor='middle' fill='#0a2540' font-family='Arial'>Muat naik gambar anda</text>
      <text x='600' y='430' font-size='28' text-anchor='middle' fill='#0a2540' font-family='Arial'>Pratonton akan muncul di tengah stage</text>
    </svg>`);
  preview.src=url;
})();
</script>
</body>
</html>
