<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Puzzle Maker — Bulan Kebangsaan</title>
<style>
  :root{
    --bg:#0a2540; --panel:#103d68; --board:#0e2d52; --accent:#ffd34d;
    --text:#eef6ff; --muted:#b8d3f0; --line:#0b2846;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:12px 16px;background:linear-gradient(180deg,#123e70,#0f3359);
    border-bottom:2px solid var(--line)}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:28px;height:28px;border-radius:6px;background:conic-gradient(#fff 0 25%,#cc0001 0 50%,#010066 0 75%,#ffcc00 0 100%);box-shadow:0 0 0 2px #07223f inset}
  .title{font-weight:800;margin:0;font-size:18px;letter-spacing:.2px}
  .controls{display:flex;flex-wrap:wrap;gap:8px}
  .btn,.select,.file{background:#0f3359;color:var(--text);border:1px solid #1a4d82;border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
  .btn:hover{background:#134674}
  input[type=file]{border:none;padding:0}
  main{display:grid;grid-template-columns:320px 1fr;gap:12px;padding:12px}
  @media (max-width:980px){ main{grid-template-columns:1fr} }
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
  .panel h2{margin:0 0 8px 0;font-size:14px;color:var(--muted);font-weight:600}
  .tray{display:flex;flex-wrap:wrap;gap:8px;min-height:120px}
  .hint{background:#0f3359;border:1px dashed #1a4d82;border-radius:10px;padding:8px 10px;color:var(--muted);font-size:12px}
  .stage{position:relative;border:2px solid var(--line);border-radius:14px;min-height:60vh;overflow:hidden;touch-action:none;
    background:
      radial-gradient(circle at 30% 30%, rgba(255,255,255,.08), transparent 40%),
      radial-gradient(circle at 70% 60%, rgba(0,0,0,.15), transparent 45%),
      linear-gradient(180deg, #2f3e52, #243445 60%, #223042);
  }
  /* Native fullscreen */
  .stage:fullscreen,.stage:-webkit-full-screen,.stage:-ms-fullscreen{
    width:100vw!important;height:100vh!important;border:none!important;border-radius:0!important
  }
  /* Pseudo-fullscreen fallback (untuk iPad/Safari degil) */
  body.fs .stage{
    position:fixed!important; inset:0!important; width:100vw!important; height:100dvh!important;
    border:none!important; border-radius:0!important; z-index:9999!important;
  }
  canvas{position:absolute;inset:0}
  footer{padding:10px 16px;color:var(--muted);font-size:12px}
  .toast{position:fixed;left:50%;top:14px;transform:translateX(-50%);background:#123e70;color:var(--text);
    border:1px solid #1a4d82;border-radius:10px;padding:8px 12px;display:none;z-index:9}
  .overlay{position:absolute;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;flex-direction:column;gap:12px;text-align:center}
  .overlay h3{margin:0;font-size:24px}
  .overlay p{margin:0}
  .overlay .btn{background:var(--accent);color:#222;border-color:#caa94a}
  .toggle{background:#0f3359;border:1px solid #1a4d82;border-radius:999px;padding:6px 10px}
  .toggle.active{background:var(--accent);color:#222;border-color:#caa94a;font-weight:700}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo" aria-hidden="true"></div>
    <h1 class="title">Selamat Menyambut Bulan Kebangsaan ke-68</h1>
  </div>
  <div class="controls">
    <label class="file">Gambar <input id="imgInput" type="file" accept="image/*"></label>
    <label class="file">MP3 <input id="mp3Input" type="file" accept="audio/mpeg,audio/mp3"></label>
    <select id="piecesSel" class="select" title="Bilangan kepingan">
      <option value="6">6 (2×3)</option><option value="8">8 (2×4)</option>
      <option value="12" selected>12 (3×4)</option><option value="14">14 (2×7)</option>
      <option value="16">16 (4×4)</option><option value="18">18 (3×6)</option>
      <option value="20">20 (4×5)</option>
    </select>
    <button id="startBtn" class="btn">Mula Puzzle</button>
    <button id="shuffleBtn" class="btn">Kacau</button>
    <button id="previewBtn" class="toggle">Preview</button>
    <button id="magnetBtn" class="toggle active">Magnet</button>
    <button id="audioArmBtn" class="btn">Bunyi: SEDIAKAN</button>
    <button id="fullBtn" class="btn">Skrin Penuh</button>
  </div>
</header>

<main>
  <section class="panel">
    <h2>Palet Kepingan</h2>
    <div id="tray" class="tray"><span class="hint">Seret kepingan ke papan & padankan. Kepingan akan “snap” bila hampir tepat.</span></div>
  </section>

  <section class="stage">
    <canvas id="board"></canvas>
    <div id="win" class="overlay">
      <h3>TAHNIAH ANDA BERJAYA!</h3>
      <p>SELAMAT MENYAMBUT BULAN KEBANGSAAN KE-68.</p>
      <button id="againBtn" class="btn">Main Lagi</button>
    </div>
  </section>
</main>

<div id="toast" class="toast"></div>
<footer>Tip iPad: selepas muat naik MP3, tekan <b>Bunyi: SEDIAKAN</b> sekali untuk membenarkan audio dimainkan automatik apabila puzzle siap.</footer>

<script>
/* ===== Util ===== */
const $ = s=>document.querySelector(s);
const toast = (m)=>{const t=$("#toast"); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2200);};

/* ===== Canvas & stage ===== */
const board=$("#board"), stageEl=board.parentElement, ctx=board.getContext("2d");
let W,H,scale=1; const DPR=Math.max(1,window.devicePixelRatio||1);

function resizeCanvas(){
  const pad=12;
  const inNativeFS = !!(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement);
  const inPseudoFS = document.body.classList.contains('fs');

  const vw = window.innerWidth;
  const vh = (window.visualViewport ? Math.round(window.visualViewport.height) : window.innerHeight);

  const w = (inNativeFS || inPseudoFS) ? vw : stageEl.clientWidth;
  const h = (inNativeFS || inPseudoFS) ? vh : Math.max(460, stageEl.clientHeight);

  W = w - pad; H = h - pad;
  board.style.left=pad/2+"px"; board.style.top=pad/2+"px";
  board.style.width=W+"px"; board.style.height=H+"px";
  board.width=Math.floor(W*DPR); board.height=Math.floor(H*DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
  draw();
}
addEventListener("resize",resizeCanvas);
["fullscreenchange","webkitfullscreenchange","msfullscreenchange"].forEach(ev=>document.addEventListener(ev,resizeCanvas));

/* ===== Model ===== */
let img=null, mp3=null, audio=new Audio();
let rows=3, cols=4, pieces=[], slots=[], dragging=null, offX=0, offY=0;
let showPreview=false, strongMagnet=true;
const mapping={6:[2,3],8:[2,4],12:[3,4],14:[2,7],16:[4,4],18:[3,6],20:[4,5]};
function setGrid(n){[rows,cols]=mapping[n];}
$("#piecesSel").onchange=e=>setGrid(+e.target.value);

/* Uploads */
$("#imgInput").addEventListener("change",e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{ img=new Image(); img.onload=()=>{toast("Gambar dimuat naik."); draw();}; img.src=ev.target.result; };
  r.readAsDataURL(f);
});
$("#mp3Input").addEventListener("change",e=>{
  mp3=e.target.files[0]?URL.createObjectURL(e.target.files[0]):null;
  if(mp3){ audio.src=mp3; toast("MP3 dimuat naik."); }
});
$("#audioArmBtn").onclick=async()=>{
  try{ if(!mp3){toast("Muat naik MP3 dahulu."); return;}
    audio.src=mp3; await audio.play(); await new Promise(r=>setTimeout(r,120));
    audio.pause(); audio.currentTime=0; toast("Audio sedia untuk auto-play.");
  }catch{ toast("Tekan sekali lagi (iPad memerlukan sentuhan)."); }
};

/* Toggles */
$("#previewBtn").onclick=()=>{ showPreview=!showPreview; $("#previewBtn").classList.toggle("active",showPreview); draw(); };
$("#magnetBtn").onclick=()=>{ strongMagnet=!strongMagnet; $("#magnetBtn").classList.toggle("active",strongMagnet); };

/* ===== Build puzzle ===== */
function buildPuzzle(){
  pieces=[]; slots=[];
  if(!img){toast("Sila muat naik gambar terlebih dahulu."); return;}
  const margin=20, boxW=W-margin*2, boxH=H-margin*2;
  const rImg=img.width/img.height, rBox=boxW/boxH;
  let tW,tH; if(rImg>rBox){tW=boxW; tH=boxW/rImg;} else {tH=boxH; tW=boxH*rImg;}
  scale=tW/img.width; const ox=(W-tW)/2, oy=(H-tH)/2;
  const pw=tW/cols, ph=tH/rows;

  // bentuk tab
  const tabsH=Array.from({length:rows},()=>Array(cols-1).fill(0));
  const tabsV=Array.from({length:rows-1},()=>Array(cols).fill(0));
  for(let r=0;r<rows;r++)for(let c=0;c<cols-1;c++) tabsH[r][c]=Math.random()>.5?1:-1;
  for(let r=0;r<rows-1;r++)for(let c=0;c<cols;c++) tabsV[r][c]=Math.random()>.5?1:-1;

  for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
    const left  =(c==0)?0: -tabsH[r][c-1];
    const right =(c==cols-1)?0: tabsH[r][c];
    const top   =(r==0)?0: -tabsV[r-1][c];
    const bottom=(r==rows-1)?0: tabsV[r][c];
    const slot={r,c,x:ox+c*pw,y:oy+r*ph,w:pw,h:ph}; slots.push(slot);

    // tabur kepingan (ala game room)
    const px = Math.random()*(W-pw);
    const py = Math.random()*(H-ph);
    const piece={r,c,x:px,y:py,w:pw,h:ph,placed:false,edges:{top,bottom,left,right}};
    pieces.push(piece);
  }
  const tray=$("#tray"); tray.innerHTML="";
  tray.append(Object.assign(document.createElement("span"),{className:"hint",textContent:"Tip: hidupkan 'Preview' untuk rujukan imej; 'Magnet' untuk snap lebih kuat."}));
  draw();
}

/* ===== Render ===== */
function drawBackground(){
  ctx.clearRect(0,0,W,H);
  if(showPreview && img){
    ctx.globalAlpha=.18;
    const tw=img.width*scale, th=img.height*scale, x=(W-tw)/2, y=(H-th)/2;
    ctx.drawImage(img,x,y,tw,th);
    ctx.globalAlpha=1;
  }
}
function jigsawPath(x,y,w,h,e){
  const tab=Math.min(w,h)*.18, k=Math.min(w,h)*.12; ctx.beginPath(); ctx.moveTo(x+k,y);
  if(e.top===0){ctx.lineTo(x+w-k,y);}else{const d=e.top; ctx.lineTo(x+w*.35,y); ctx.bezierCurveTo(x+w*.35,y-d*tab,x+w*.65,y-d*tab,x+w*.65,y); ctx.lineTo(x+w-k,y);}
  ctx.quadraticCurveTo(x+w,y,x+w,y+k);
  if(e.right===0){ctx.lineTo(x+w,y+h-k);}else{const d=e.right; ctx.lineTo(x+w,y+h*.35); ctx.bezierCurveTo(x+w+d*tab,y+h*.35,x+w+d*tab,y+h*.65,x+w,y+h*.65); ctx.lineTo(x+w,y+h-k);}
  ctx.quadraticCurveTo(x+w,y+h,x+w-k,y+h);
  if(e.bottom===0){ctx.lineTo(x+k,y+h);}else{const d=e.bottom; ctx.lineTo(x+w*.65,y+h); ctx.bezierCurveTo(x+w*.65,y+h+d*tab,x+w*.35,y+h+d*tab,x+w*.35,y+h); ctx.lineTo(x+k,y+h);}
  ctx.quadraticCurveTo(x,y+h,x,y+h-k);
  if(e.left===0){ctx.lineTo(x,y+k);}else{const d=e.left; ctx.lineTo(x,y+h*.65); ctx.bezierCurveTo(x-d*tab,y+h*.65,x-d*tab,y+h*.35,x,y+h*.35); ctx.lineTo(x,y+k);}
  ctx.quadraticCurveTo(x,y,x+k,y); ctx.closePath();
}

function drawPiece3D(p){
  if(!img) return;
  const r=scale;
  // Bayang
  ctx.save();
  ctx.shadowColor="rgba(0,0,0,.35)";
  ctx.shadowBlur=Math.min(p.w,p.h)*0.15;
  ctx.shadowOffsetX=Math.min(p.w,p.h)*0.06;
  ctx.shadowOffsetY=Math.min(p.w,p.h)*0.06;
  jigsawPath(p.x,p.y,p.w,p.h,p.edges); ctx.clip();

  const tw=img.width*r, th=img.height*r, bx=(W-tw)/2, by=(H-th)/2;
  ctx.drawImage(img, bx, by, tw, th, bx+p.c*p.w, by+p.r*p.h, p.w, p.h);
  ctx.restore();

  // Tepi putih & kontur
  ctx.lineWidth=Math.max(2,Math.min(p.w,p.h)*0.06);
  ctx.strokeStyle="rgba(255,255,255,.95)"; jigsawPath(p.x,p.y,p.w,p.h,p.edges); ctx.stroke();
  ctx.lineWidth=1.2; ctx.strokeStyle="rgba(0,0,0,.35)"; jigsawPath(p.x,p.y,p.w,p.h,p.edges); ctx.stroke();

  // Highlight lembut
  const g1=ctx.createLinearGradient(p.x,p.y,p.x,p.y+p.h);
  g1.addColorStop(0,"rgba(255,255,255,.28)"); g1.addColorStop(.5,"rgba(255,255,255,0)");
  ctx.fillStyle=g1; jigsawPath(p.x,p.y,p.w,p.h,p.edges); ctx.fill();
  const g2=ctx.createLinearGradient(p.x,p.y,p.x+p.w,p.y+p.h);
  g2.addColorStop(.5,"rgba(0,0,0,0)"); g2.addColorStop(1,"rgba(0,0,0,.18)");
  ctx.fillStyle=g2; jigsawPath(p.x,p.y,p.w,p.h,p.edges); ctx.fill();
}

function draw(){
  drawBackground();
  for(const p of pieces){ if(p!==dragging) drawPiece3D(p); }
  if(dragging) drawPiece3D(dragging);
}

/* ===== Interaksi ===== */
function pick(px,py){ for(let i=pieces.length-1;i>=0;i--){ const p=pieces[i]; jigsawPath(p.x,p.y,p.w,p.h,p.edges); if(ctx.isPointInPath(px,py)) return p; } return null;}
function down(e){ const r=board.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; const p=pick(x,y); if(p){dragging=p; offX=x-p.x; offY=y-p.y;} }
function move(e){ if(!dragging) return; const r=board.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; dragging.x=x-offX; dragging.y=y-offY; draw(); }
function up(){
  if(!dragging) return;
  const p=dragging; const s=slots[p.r*cols+p.c];
  const tol = Math.min(p.w,p.h)*(strongMagnet?0.45:0.28);
  const near = Math.hypot(p.x-s.x,p.y-s.y) < tol;
  if(near){ p.x=s.x; p.y=s.y; p.placed=true; }
  dragging=null; draw(); checkWin();
}
board.addEventListener("mousedown",down); addEventListener("mousemove",move); addEventListener("mouseup",up);
board.addEventListener("touchstart",down,{passive:true}); board.addEventListener("touchmove",move,{passive:true}); board.addEventListener("touchend",up);

/* ===== Win ===== */
function checkWin(){
  if(pieces.length && pieces.every(p=>p.placed)){
    $("#win").style.display="flex";
    if(mp3){ audio.currentTime=0; audio.play().catch(()=>{}); }
  }
}
$("#againBtn").onclick=()=>{ $("#win").style.display="none"; shuffle(); };

/* ===== Shuffle ===== */
function shuffle(){ for(const p of pieces){ p.placed=false; p.x=Math.random()*(W-p.w); p.y=Math.random()*(H-p.h);} draw(); }
$("#shuffleBtn").onclick=shuffle;

/* ===== Start ===== */
$("#startBtn").onclick=()=>{ if(!img){toast("Muat naik gambar dahulu."); return;} setGrid(+$("#piecesSel").value); buildPuzzle(); toast(`Puzzle ${rows*cols} keping disediakan.`); };

/* ===== Fullscreen (native + fallback) ===== */
function fsSupported(){ return !!(document.fullscreenEnabled||document.webkitFullscreenEnabled||document.msFullscreenEnabled); }
function isFS(){ return !!(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement); }
function enterFS(el){ (el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen)?.call(el); }
function exitFS(){ (document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen)?.call(document); }
function usePseudoFS(on){ document.body.classList.toggle('fs',!!on); resizeCanvas(); }

$("#fullBtn").onclick=()=>{ 
  if (fsSupported()) { if(!isFS()) enterFS(stageEl); else exitFS(); }
  else { usePseudoFS(!document.body.classList.contains('fs')); }
};
["fullscreenchange","webkitfullscreenchange","msfullscreenchange"].forEach(ev=>{
  document.addEventListener(ev, ()=>{ if(!isFS()) document.body.classList.remove('fs'); resizeCanvas(); });
});

function init(){ resizeCanvas(); }
init();
</script>
</body>
</html>
