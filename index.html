<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Puzzle Malaysia — Sijil: Tandatangan Terus + Auto Muzik</title>
<style>
:root{--bg:#0a2540;--panel:#0f3359;--line:#0b2846;--text:#eaf3ff;--accent:#ffd34d;--muted:#b8d3f0}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
header{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;padding:10px 14px;background:linear-gradient(180deg,#123e70,#0f3359);border-bottom:2px solid var(--line)}
.controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;width:100%}
.btn,.select,.file,.range{background:var(--panel);color:var(--text);border:1px solid #1a4d82;border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
.btn[disabled]{opacity:.55;cursor:not-allowed}
.btn:hover:not([disabled]){background:#134674}
.file input[type=file]{border:none;padding:0}
.range{display:flex;align-items:center;gap:8px}
.range input{accent-color:var(--accent)}
main{padding:10px}
.stage{position:relative;border:2px solid var(--line);border-radius:14px;min-height:82vh;overflow:hidden;touch-action:none;background:#0a2540}
canvas{position:absolute;inset:0}
.toggle{background:var(--panel);border:1px solid #1a4d82;border-radius:999px;padding:6px 10px}
.toggle.active{background:var(--accent);color:#222;border-color:#c9a43c;font-weight:700}
.toast{position:fixed;left:50%;top:12px;transform:translateX(-50%);background:#123e70;color:#fff;border:1px solid #1a4d82;border-radius:10px;padding:8px 12px;display:none;z-index:9}
footer{padding:10px 14px;color:var(--muted);font-size:12px}

/* Overlay kemenangan */
#celebrate{position:absolute;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;background:rgba(0,0,0,.85);z-index:30}
#celebrate.show{display:flex;animation:fadeIn .45s ease both}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.big-wrap{width:min(96%,1200px);max-height:80vh;display:grid;place-items:center;padding:10px}
.big-img{width:100%;max-height:70vh;object-fit:contain;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.6),inset 0 0 0 2px rgba(255,255,255,.08);background:#061a2e}
.title{margin-top:14px;text-align:center;line-height:1.25;font-weight:800;letter-spacing:.5px;text-shadow:0 2px 8px rgba(0,0,0,.7)}
.title .line1{font-size:min(5.5vw,38px)}
.title .line2{font-size:min(5vw,34px);color:var(--accent)}
.actions{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap}
.closeX{position:absolute;top:12px;right:12px;width:42px;height:42px;border-radius:999px;border:1px solid #c9a43c;background:var(--accent);color:#1b1b1b;font-weight:900;font-size:20px;cursor:pointer}

/* Paparan sijil */
#certPane{display:none;position:absolute;inset:0;background:linear-gradient(180deg,#0a2540,#061a2e);z-index:25;padding:16px;overflow:auto}
.cert-wrap{max-width:1180px;margin:0 auto;display:grid;gap:14px}
.panel{background:#0f3359;border:1px solid #1a4d82;border-radius:12px;padding:12px}
.cert-canvas-wrap{display:grid;place-items:center}
#certCanvas{width:100%;max-width:1000px;background:#fff;border-radius:12px;touch-action:none;cursor:crosshair}
.tools{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between}
.tools > div{display:flex;gap:8px;align-items:center}
.chk{display:flex;align-items:center;gap:6px}
</style>
</head>
<body>
<header>
  <div style="font-weight:800;white-space:nowrap">Jigsaw Puzzle Malaysia Ke-68</div>
  <div class="controls">
    <label class="file">Gambar <input id="imgInput" type="file" accept="image/*"></label>

    <select id="piecesSel" class="select">
      <option value="6">6 (2×3)</option><option value="8">8 (2×4)</option>
      <option value="10">10 (2×5)</option><option value="12" selected>12 (3×4)</option>
      <option value="16">16 (4×4)</option><option value="20">20 (4×5)</option>
      <option value="24">24 (3×8)</option>
    </select>

    <button id="startBtn" class="btn">Mula Puzzle</button>
    <button id="shuffleBtn" class="btn">Kacau</button>
    <button id="previewBtn" class="toggle">Preview</button>
    <button id="fsBtn" class="btn">Skrin Penuh</button>

    <!-- Muzik -->
    <label class="file">Muzik MP3
      <!-- terima banyak format + .mp3 khusus -->
      <input id="mp3Input" type="file" accept="audio/*,.mp3,.m4a,.aac,.wav,.ogg">
    </label>
    <span id="mp3Name" style="opacity:.9"></span>
    <div class="range">Vol Muzik <input id="volRange" type="range" min="0" max="1" step="0.05" value="0.8"></div>

    <!-- Upload sijil DI SINI (bawah MP3) -->
    <label class="file">Sijil (PNG/JPG)
      <input id="certUpload" type="file" accept="image/*">
    </label>
    <span id="certName" style="opacity:.9"></span>
  </div>
</header>

<main>
  <section id="stage" class="stage">
    <canvas id="board"></canvas>

    <!-- Overlay kemenangan -->
    <div id="celebrate" aria-live="polite">
      <button id="closeMusic" class="closeX" title="Hentikan muzik & tutup">×</button>
      <div class="big-wrap"><img id="celebrateImg" class="big-img" alt="Gambar kemenangan"></div>
      <div class="title">
        <div class="line1">SELAMAT MENYAMBUT BULAN KEBANGSAAN KE-68</div>
        <div class="line2">SK BUKIT TONGKAT</div>
      </div>
      <div class="actions">
        <button id="againBtn" class="btn">Main Lagi</button>
        <button id="openCertWin" class="btn" style="background:#ffd34d;color:#1b1b1b;border-color:#c9a43c;font-weight:700">Pergi ke Sijil</button>
        <!-- Ditunjukkan jika autoplay gagal pada iOS -->
        <button id="enableSound" class="btn" style="display:none">Aktifkan Bunyi</button>
      </div>
    </div>

    <!-- Paparan Sijil -->
    <div id="certPane">
      <div class="cert-wrap">
        <div class="panel tools">
          <div>
            <div class="chk"><input id="penOnly" type="checkbox" checked><label for="penOnly">Pen sahaja (palm rejection)</label></div>
            <div class="range">Lebar Garis <input id="baseWidth" type="range" min="0.5" max="6" step="0.5" value="2.5"></div>
          </div>
          <div>
            <button id="undoSig" class="btn">Undo</button>
            <button id="clearSig" class="btn">Clear</button>
            <button id="savePNG" class="btn" style="background:#ffd34d;color:#1b1b1b;border-color:#c9a43c;font-weight:700">Muat Turun PNG</button>
            <button id="backToWin" class="btn">Tutup</button>
          </div>
        </div>

        <div class="panel cert-canvas-wrap">
          <canvas id="certCanvas" width="3508" height="2480" title="Tandatangan terus pada sijil (guna Apple Pencil)"></canvas>
          <div style="opacity:.9;font-size:12px;margin-top:6px">Nota: Sijil menggunakan fail PNG/JPG yang anda upload di atas. Tandatangan terus di atas sijil.</div>
        </div>
      </div>
    </div>
  </section>
</main>

<div id="toast" class="toast"></div>
<footer>Muzik auto main bila menang (dengan kaedah unlock audio). Jika tidak, tekan “Aktifkan Bunyi”.</footer>

<audio id="bgm" preload="auto" playsinline></audio>

<script>
/* ===== util ===== */
const $=s=>document.querySelector(s);
function toast(m){const t=$("#toast");t.textContent=m;t.style.display='block';setTimeout(()=>t.style.display='none',1600);}
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));

/* ===== puzzle setup (ringkas) ===== */
const stageEl=$("#stage");
const board=$("#board"), ctx=board.getContext("2d",{alpha:false});
let W=0,H=0,DPR=Math.max(1,window.devicePixelRatio||1);
function resizeCanvas(){
  const pad=10, w=stageEl.clientWidth, h=Math.max(660,stageEl.clientHeight);
  W=w-pad; H=h-pad;
  board.style.left=board.style.top=(pad/2)+"px";
  board.style.width=W+"px"; board.style.height=H+"px";
  board.width=Math.floor(W*DPR); board.height=Math.floor(H*DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
  draw();
}
addEventListener("resize",()=>{ resizeCanvas(); if(img && built) buildPuzzle(); });

let img=null; let rows=3, cols=4;
let pieces=[], targets=[], OX=0, OY=0, CELL=0, dragging=null, offX=0, showPreview=false, built=false;
let trayW=0, margin=14, gutter=10;

/* ====== AUDIO: load + unlock + autoplay selepas menang ====== */
const bgm=$("#bgm"); let mp3URL=null; let audioUnlocked=false;

$("#volRange").addEventListener("input", e => bgm.volume=+e.target.value);
bgm.volume=+$("#volRange").value;

// 1) Unlock audio sekali: mana-mana sentuhan pertama
function unlockAudio(){
  if(audioUnlocked) return;
  try{
    const p=bgm.play(); // cuba main (tiada src pun tak apa)
    if(p && p.then){
      p.then(()=>{ bgm.pause(); bgm.currentTime=0; audioUnlocked=true; document.removeEventListener('pointerdown',unlockAudio,true); })
       .catch(()=>{ /* ignore */ });
    }else{
      audioUnlocked=true;
      document.removeEventListener('pointerdown',unlockAudio,true);
    }
  }catch(_){}
}
document.addEventListener('pointerdown',unlockAudio,true);

// 2) Upload fail MP3
$("#mp3Input").addEventListener("change", e=>{
  const f=e.target.files?.[0]; if(!f){ toast("Tiada fail muzik."); return; }
  if(mp3URL) URL.revokeObjectURL(mp3URL);
  mp3URL = URL.createObjectURL(f);
  bgm.src = mp3URL;
  bgm.load();
  bgm.muted = false;
  $("#mp3Name").textContent = "• " + f.name;
  toast("Muzik dimuat naik. Ia akan dimainkan bila anda menang.");
});

// 3) Cuba main semasa menang; jika gagal, tunjuk butang “Aktifkan Bunyi”
function tryPlayBgm(){
  if(!bgm.src) return;
  bgm.loop=true;
  const p = bgm.play();
  if(p && p.then){
    p.then(()=>{ $("#enableSound").style.display="none"; })
     .catch(()=>{ $("#enableSound").style.display="inline-block"; });
  }
}
$("#enableSound").addEventListener("click",()=>{ tryPlayBgm(); });

/* ===== Upload sijil (di header) ===== */
let certImg=null;
$("#certUpload").addEventListener("change",e=>{
  const f=e.target.files?.[0]; if(!f){ certImg=null; $("#certName").textContent=""; renderCert(); return; }
  const r=new FileReader();
  r.onload=ev=>{ certImg=new Image(); certImg.onload=()=>{ $("#certName").textContent="• "+f.name; toast("Sijil dimuat naik."); renderCert(); }; certImg.src=ev.target.result; };
  r.readAsDataURL(f);
});

/* ===== controls asas ===== */
const mapping={6:[2,3],8:[2,4],10:[2,5],12:[3,4],16:[4,4],20:[4,5],24:[3,8]};
$("#piecesSel").addEventListener("change",e=>{ const v=+e.target.value; rows=mapping[v][0]; cols=mapping[v][1]; if(img) buildPuzzle(); });
$("#previewBtn").addEventListener("click",function(){ showPreview=!showPreview; this.classList.toggle("active",showPreview); draw(); });
$("#startBtn").addEventListener("click",()=>{ if(!img) return toast("Muat naik gambar dahulu."); buildPuzzle(); });
$("#shuffleBtn").addEventListener("click",()=>shuffle());
$("#imgInput").addEventListener("change",e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{ img=new Image(); img.onload=()=>{ $("#celebrateImg").src=img.src; buildPuzzle(); }; img.src=ev.target.result; };
  r.readAsDataURL(f);
});
function isFS(){return document.fullscreenElement||document.webkitFullscreenElement;}
$("#fsBtn").addEventListener("click",()=>{ try{ if(!isFS()){ const el=stageEl; (el.requestFullscreen||el.webkitRequestFullscreen).call(el); $("#fsBtn").textContent="Keluar Skrin Penuh"; } else { (document.exitFullscreen||document.webkitExitFullscreen).call(document); $("#fsBtn").textContent="Skrin Penuh"; } }catch(e){} });
document.addEventListener("fullscreenchange",()=>{ $("#fsBtn").textContent=isFS()?"Keluar Skrin Penuh":"Skrin Penuh"; });

/* ===== helper ===== */
function rectPath(c,x,y,w,h){ c.beginPath(); c.rect(x,y,w,h); c.closePath(); }

/* ===== bina puzzle ===== */
function buildPuzzle(){
  pieces=[]; targets=[]; built=true;
  const usableH = H - margin*2;
  const tw = Math.max(Math.round(W*0.12),84); trayW=tw;
  const usableW2 = W - margin*2 - 2*trayW - 2*gutter;
  CELL = Math.max(48, Math.min(Math.floor(usableW2/cols), Math.floor(usableH/rows)));
  OX = Math.round(margin + trayW + gutter + ( (W - 2*(trayW+gutter) - margin*2) - CELL*cols )/2);
  OY = Math.round(margin + (usableH - CELL*rows)/2);
  const sW=img.width/cols, sH=img.height/rows;
  for(let r=0;r<rows;r++)for(let c=0;c<cols;c++){
    const tx=OX+c*CELL, ty=OY+r*CELL;
    const sx=c*sW, sy=r*sH;
    const can=document.createElement('canvas'); can.width=CELL*2; can.height=CELL*2;
    const g=can.getContext('2d'); g.scale(2,2);
    rectPath(g,0,0,CELL,CELL); g.clip();
    g.drawImage(img,sx,sy,sW,sH,0,0,CELL,CELL);
    pieces.push({r,c,x:tx,y:ty,w:CELL,h:CELL,img:can,at:{x:0,y:0},placed:false});
    targets.push({x:tx,y:ty,r,c});
  }
  shuffle(); draw();
}
function shuffle(){
  if(!built || !pieces.length){ draw(); return; }
  const pad=10,gap=8,leftX=Math.round(margin),rightX=Math.round(W-margin-trayW);
  const total=pieces.length,leftCount=Math.ceil(total/2),rightCount=total-leftCount;
  const rmax=Math.max(1,Math.floor((H-margin*2-pad*2)/(CELL+gap)));
  const colsLeft=Math.max(1,Math.ceil(leftCount/rmax));
  const colsRight=Math.max(1,Math.ceil(rightCount/rmax));
  let i=0; for(;i<leftCount;i++){ const c=i%colsLeft,r=Math.floor(i/colsLeft); pieces[i].at.x=leftX+pad+c*(CELL+gap); pieces[i].at.y=Math.round(margin+pad+r*(CELL+gap)); pieces[i].placed=false; }
  for(let k=0;k<rightCount;k++){ const idx=i+k,c=k%colsRight,r=Math.floor(k/colsRight); pieces[idx].at.x=rightX+pad+c*(CELL+gap); pieces[idx].at.y=Math.round(margin+pad+r*(CELL+gap)); pieces[idx].placed=false; }
}
function draw(){
  ctx.fillStyle='#071a2f'; ctx.fillRect(0,0,W,H);
  drawTray(Math.round(margin),Math.round(margin),Math.round(trayW),H-margin*2);
  drawTray(Math.round(W-margin-trayW),Math.round(margin),Math.round(trayW),H-margin*2);
  ctx.save(); ctx.fillStyle='#061a2e'; ctx.strokeStyle='rgba(255,255,255,.10)'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.rect(OX-8, OY-8, CELL*cols+16, CELL*rows+16); ctx.fill(); ctx.stroke(); ctx.restore();
  if(showPreview && img){ ctx.save(); ctx.globalAlpha=0.28; ctx.drawImage(img,0,0,img.width,img.height, OX,OY, CELL*cols, CELL*rows); ctx.restore(); }
  for(const p of pieces){ if(p===dragging || p.placed) continue; drawPiece(p,true); }
  if(dragging) drawPiece(dragging,true,true);
  for(const p of pieces){ if(!p.placed || p===dragging) continue; drawPiece(p,false); }
}
function drawTray(x,y,w,h){ ctx.save(); ctx.fillStyle='rgba(11,42,74,.96)'; ctx.strokeStyle='rgba(255,255,255,.08)'; ctx.lineWidth=1; ctx.beginPath(); ctx.rect(x,y,w,h); ctx.fill(); ctx.stroke(); ctx.restore(); }
function drawPiece(p,floating,lift){
  if(floating){ ctx.save(); if(lift){ ctx.shadowColor='rgba(0,0,0,.35)'; ctx.shadowBlur=12; ctx.shadowOffsetY=6; }
    ctx.drawImage(p.img, Math.round(p.at.x), Math.round(p.at.y), p.w, p.h); ctx.restore();
    ctx.save(); ctx.lineWidth=Math.max(1.1,p.w*0.04); ctx.strokeStyle='rgba(255,255,255,.95)'; rectPath(ctx, Math.round(p.at.x), Math.round(p.at.y), p.w, p.h); ctx.stroke(); ctx.restore();
    ctx.save(); ctx.lineWidth=1; ctx.strokeStyle='rgba(0,0,0,.20)'; rectPath(ctx, Math.round(p.at.x), Math.round(p.at.y), p.w, p.h); ctx.stroke(); ctx.restore();
  }else{ ctx.drawImage(p.img, Math.round(p.x), Math.round(p.y), p.w, p.h); }
}
function pieceAt(px,py){ for(let i=pieces.length-1;i>=0;i--){ const p=pieces[i],x=p.at.x,y=p.at.y,w=p.w,h=p.h; if(px>=x&&px<=x+w&&py>=y&&py<=y+h) return p; } return null; }
board.addEventListener("pointerdown",e=>{ e.preventDefault(); try{board.setPointerCapture(e.pointerId);}catch{} const r=board.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top; const p=pieceAt(x,y); if(!p) return; dragging=p; offX=x-p.at.x; offY=y-p.at.y; const i=pieces.indexOf(p); pieces.push(pieces.splice(i,1)[0]); requestAnimationFrame(draw);},{passive:false});
board.addEventListener("pointermove",e=>{ if(!dragging) return; e.preventDefault(); const r=board.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top; dragging.at.x=x-offX; dragging.at.y=y-offY; requestAnimationFrame(draw);},{passive:false});
board.addEventListener("pointerup",e=>{ if(!dragging) return; e.preventDefault(); const p=dragging; dragging=null; const snap=findNearestTarget(p.at.x+p.w/2,p.at.y+p.h/2); if(snap && !occupied(snap.r,snap.c)){ p.at.x=snap.x; p.at.y=snap.y; p.placed=(p.r===snap.r && p.c===snap.c); } draw(); checkWin(); },{passive:false});
function findNearestTarget(cx,cy){ const GW=CELL*cols,GH=CELL*rows; if(cx>=OX&&cx<=OX+GW&&cy>=OY&&cy<=OY+GH){ const c=Math.floor((cx-OX)/CELL), r=Math.floor((cy-OY)/CELL); return targets[r*cols+c]; } return null; }
function occupied(rr,cc){ return pieces.some(p=>p.placed && p.r===rr && p.c===cc); }
function checkWin(){
  for(const p of pieces){ if(!(p.at.x===p.x && p.at.y===p.y)) return; }
  $("#celebrateImg").src=img?.src||"";
  $("#celebrate").classList.add("show");
  // main muzik (autoplay)
  tryPlayBgm();
}
$("#againBtn").addEventListener("click",()=>{ $("#celebrate").classList.remove("show"); $("#enableSound").style.display="none"; shuffle(); draw(); });
$("#openCertWin").addEventListener("click",()=>{ if(!certImg){ toast("Sila upload Sijil (PNG/JPG) dahulu (di bawah MP3)."); return; } $("#certPane").style.display='block'; renderCert(); });
$("#closeMusic").addEventListener("click",()=>{ try{ if(!bgm.paused){ bgm.pause(); bgm.currentTime=0; } }catch{} $("#celebrate").classList.remove("show"); });

/* ====== SIJIL: tandatangan terus atas canvas ====== */
const certCanvas=$("#certCanvas"), cg=certCanvas.getContext("2d");
let strokes=[], currentStroke=null;
const penOnly=$("#penOnly"), baseWidth=$("#baseWidth");

function renderCert(){
  const W=certCanvas.width, H=certCanvas.height;
  cg.fillStyle="#ffffff"; cg.fillRect(0,0,W,H);
  if(certImg){
    const r=certImg.width/certImg.height, rb=W/H; let dw,dh;
    if(r>rb){ dw=W; dh=Math.round(W/r);} else { dh=H; dw=Math.round(H*r); }
    const dx=Math.round((W-dw)/2), dy=Math.round((H-dh)/2);
    cg.drawImage(certImg,0,0,certImg.width,certImg.height, dx,dy,dw,dh);
  }else{
    cg.fillStyle="#eee"; cg.fillRect(0,0,W,H);
    cg.fillStyle="#333"; cg.font="700 100px system-ui"; cg.textAlign="center";
    cg.fillText("Sila upload Sijil (PNG/JPG) di bahagian atas.", W/2, H/2);
  }
  // lukis tandatangan
  cg.lineJoin="round"; cg.lineCap="round"; cg.strokeStyle="#111";
  for(const s of strokes){
    cg.beginPath();
    for(let i=0;i<s.pts.length;i++){
      const pt=s.pts[i];
      const w=Math.max(0.5,(s.base||2.5)*(pt.p? (0.5+pt.p):1));
      cg.lineWidth=w;
      if(i===0) cg.moveTo(pt.x,pt.y); else cg.lineTo(pt.x,pt.y);
    }
    cg.stroke();
  }
}
function addPt(e){
  const rect=certCanvas.getBoundingClientRect();
  const sx=certCanvas.width/rect.width, sy=certCanvas.height/rect.height;
  const x=(e.clientX-rect.left)*sx, y=(e.clientY-rect.top)*sy;
  const p=(typeof e.pressure==="number" && e.pressure>0)? e.pressure : 1;
  currentStroke.pts.push({x,y,p});
}
certCanvas.addEventListener("pointerdown",e=>{
  if(penOnly.checked && e.pointerType!=="pen") return;
  certCanvas.setPointerCapture(e.pointerId);
  currentStroke={pts:[], base:parseFloat(baseWidth.value)||2.5};
  addPt(e); strokes.push(currentStroke); renderCert();
});
certCanvas.addEventListener("pointermove",e=>{
  if(!currentStroke) return;
  if(penOnly.checked && e.pointerType!=="pen") return;
  addPt(e); renderCert();
});
function endStroke(){ currentStroke=null; }
certCanvas.addEventListener("pointerup",endStroke);
certCanvas.addEventListener("pointercancel",endStroke);

$("#undoSig").addEventListener("click",()=>{ strokes.pop(); renderCert(); });
$("#clearSig").addEventListener("click",()=>{ strokes.length=0; renderCert(); });
$("#backToWin").addEventListener("click",()=>{ $("#certPane").style.display='none'; });
$("#savePNG").addEventListener("click",()=>{ renderCert(); const a=document.createElement("a"); a.download="Sijil_Tandatangan.png"; a.href=certCanvas.toDataURL("image/png"); a.click(); });

/* ===== mula ===== */
resizeCanvas(); renderCert();
</script>
</body>
</html>
